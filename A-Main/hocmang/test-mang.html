<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô Phỏng Mạng Toàn Diện - DDoS Effects</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --bg-dark: #1e1e2f;
            --bg-light: #27293d;
            --primary-blue: #0d6efd;
            --secondary-yellow: #ffc107;
            --text-light: #e0e0e0;
            --border-color: #44475a;
            --red-error: #e53935;
            --green-success: #43a047;
            --purple-action: #6f42c1;
            --cable-color: #78909c;
            --export-color: #20c997;
            --import-color: #17a2b8;
            --ddos-color: #b71c1c;
        }

        @keyframes blink-error {
            0% { box-shadow: 0 0 10px var(--red-error); }
            50% { box-shadow: none; }
            100% { box-shadow: 0 0 10px var(--red-error); }
        }
        @keyframes highlight-success {
            0% { box-shadow: 0 0 12px var(--green-success); }
            100% { box-shadow: none; }
        }
        @keyframes data-flow { to { stroke-dashoffset: 0; } }

        @keyframes ddos-pulse {
            0% { box-shadow: 0 0 18px var(--red-error), inset 0 0 10px rgba(255, 82, 82, 0.5); }
            50% { box-shadow: 0 0 8px var(--red-error), inset 0 0 4px rgba(255, 82, 82, 0.2); }
            100% { box-shadow: 0 0 18px var(--red-error), inset 0 0 10px rgba(255, 82, 82, 0.5); }
        }
        @keyframes ddos-packet-flow {
            from { opacity: 1; }
            to { opacity: 0; transform: translate(var(--tx), var(--ty)); }
        }
        
        @keyframes ddos-cable-flow {
            to { stroke-dashoffset: -100; }
        }


        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 95%; max-width: 1600px; height: 90vh;
            background-color: var(--bg-light); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .workspace {
            flex-grow: 1; position: relative; overflow: hidden;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        #cable-svg {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; pointer-events: none;
        }
        #cable-svg line {
            pointer-events: all; cursor: pointer;
            transition: opacity 0.4s ease-in-out, stroke 0.3s linear;
        }
        
        #ddos-packet-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .ddos-packet {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: var(--secondary-yellow);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--secondary-yellow);
            animation-name: ddos-packet-flow;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }


        .cable-ping {
            stroke: var(--secondary-yellow); stroke-width: 4px;
            stroke-dasharray: 8 12; stroke-dashoffset: 200;
            animation: data-flow 1.5s linear forwards;
            pointer-events: none;
        }
        
        .cable-under-ddos {
            stroke: var(--red-error);
            stroke-dasharray: 10 15;
            animation: ddos-cable-flow 1s linear infinite;
        }


        .ping-packet-text {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            font-weight: bold;
            fill: var(--secondary-yellow);
            pointer-events: none;
            text-anchor: middle;
        }


        .device {
            background-color: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 8px; padding: 8px; text-align: center;
            width: 100px; height: 125px; 
            display: flex; flex-direction: column; justify-content: space-around;
            position: absolute; user-select: none; cursor: grab;
            transition: box-shadow 0.3s, border-color 0.3s, opacity 0.4s ease-in-out, height 0.3s;
        }
        .device:hover { border-color: var(--primary-blue); }
        .device.selected-for-connection { border-color: var(--secondary-yellow); box-shadow: 0 0 15px var(--secondary-yellow); }
        .device.ip-conflict { border-style: dashed; animation: blink-error 1.5s infinite; }
        .device.highlight { animation: highlight-success 1s ease-out; }
        .device.ping-source { border-color: var(--primary-blue); box-shadow: 0 0 15px var(--primary-blue); }
        
        .device.ddos-server {
            border-color: var(--ddos-color);
            background-color: #3f2a3a;
        }
        .device.under-ddos {
            animation: ddos-pulse 1s infinite;
            border-color: var(--red-error);
        }
        .device.ddos-protected {
            border-color: var(--primary-blue);
            box-shadow: 0 0 15px var(--primary-blue), inset 0 0 8px rgba(13, 110, 253, 0.5);
        }
        
        .device.device-ddos-victim {
            opacity: 0.6;
            border-color: var(--red-error);
            pointer-events: none;
        }

        .device-icon { font-size: 2rem; }
        .device-name { font-weight: bold; margin: 4px 0; font-size: 14px; }
        .ip-input {
            width: 90%; background-color: var(--bg-light); border: 1px solid var(--border-color);
            color: var(--text-light); border-radius: 4px; padding: 3px;
            text-align: center; font-family: 'Courier New', Courier, monospace; font-size: 11px;
            margin-bottom: 3px;
            cursor: text;
        }
        
        .public-ip-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 11px; color: var(--secondary-yellow); padding: 3px;
            background-color: #111118; border-radius: 4px; width: 90%;
            margin: 0 auto; min-height: 19px; box-sizing: border-box;
        }

        .public-ip-on-device {
            font-family: 'Courier New', Courier, monospace;
            font-size: 10px;
            color: var(--secondary-yellow);
            background-color: #2c2e43;
            border-radius: 3px;
            padding: 2px 4px;
            margin-top: 2px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            min-height: 17px;
            transition: color 0.3s;
        }
        
        .device-screen {
            position: absolute; top: 25px; left: 50%;
            transform: translateX(-50%); width: 65px; height: 40px;
            background-color: rgba(0,0,0,0.7); border-radius: 4px;
            z-index: 2; pointer-events: none; transition: all 0.5s;
            opacity: 0; display: flex; align-items: center; justify-content: center;
        }
        .device.has-connection .device-screen { opacity: 1; }
        .screen-internet {
            background-image: url('https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png');
            background-size: contain; background-repeat: no-repeat;
            background-position: center; background-color: #fff;
        }
        .screen-lan-only::before {
            content: "NO INTERNET\A USE LAN"; white-space: pre-wrap;
            color: var(--secondary-yellow); font-size: 8px; font-weight: bold;
            text-align: center; line-height: 1.2;
        }
        
        .screen-ip-conflict-visuals {
            background-color: var(--red-error) !important;
        }
        .screen-ip-conflict-visuals::before {
            content: "TRÙNG IP";
            color: var(--secondary-yellow);
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        
        .device.under-ddos .device-screen {
             opacity: 1;
             background-color: var(--ddos-color) !important;
        }
        .device.under-ddos .device-screen::before {
            content: "OVERLOAD!\A(DDoS)"; white-space: pre-wrap;
            color: white; font-size: 12px; font-weight: bold;
            text-shadow: 1px 1px 2px black;
            text-align: center;
        }

        .device.device-ddos-victim .device-screen {
            opacity: 1;
            background: var(--red-error) !important;
        }
        .device.device-ddos-victim .device-screen::before {
            content: "MẤT KẾT NỐI";
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
        }

        .remove-btn, .ping-btn, .connect-btn {
            position: absolute; color: white; border: none; border-radius: 50%;
            width: 20px; height: 20px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        .remove-btn { top: -7px; right: -7px; background: var(--red-error); }
        .ping-btn { bottom: -7px; right: -7px; background: var(--primary-blue); font-size: 12px; }
        .connect-btn { bottom: -7px; left: -7px; background: var(--secondary-yellow); font-size: 12px; }
        .device:hover .remove-btn, .device:hover .ping-btn, .device:hover .connect-btn { opacity: 1; }

        .controls-panel { flex-basis: 350px; flex-shrink: 0; background-color: var(--bg-dark); padding: 20px; border-left: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; }
        .controls-panel h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .io-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .io-buttons button { flex-grow: 1; padding: 10px; font-size: 1rem; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #export-btn { background-color: var(--import-color); }
        #import-btn { background-color: var(--export-color); }
        
        .control-buttons button, .batch-controls button { width: 100%; padding: 12px; font-size: 1rem; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: background-color 0.2s, opacity 0.2s; }
        
        .controls-panel select {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            color: var(--text-light);
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e0e0e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        #add-selected-device-btn { background-color: var(--primary-blue); }
        #auto-ip-btn { background-color: var(--green-success); }
        #add-ddos-btn { background-color: var(--ddos-color); }
        
        .batch-controls { margin-top: 15px; }
        .batch-controls input { width: calc(100% - 22px); padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-light); color: var(--text-light); font-size: 1rem; }
        .log-panel { margin-top: 20px; flex-grow: 1; background-color: #111118; border-radius: 8px; padding: 15px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 13px; min-height: 150px; }
        #log-list { list-style-type: none; padding: 0; margin: 0; }
        #log-list li { padding: 4px 0; border-bottom: 1px dashed var(--border-color); word-break: break-word; }
        .log-success { color: var(--green-success); }
        .log-error { color: var(--red-error); font-weight: bold; }
        .log-info { color: var(--text-light); }
        .log-warn { color: var(--secondary-yellow); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--bg-light); padding: 25px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 80vh; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .modal-content h4 { margin-top: 0; color: var(--secondary-yellow); }
        #cable-context-menu { position: absolute; background-color: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; z-index: 3000; }
        #cable-context-menu button { background: none; border: none; color: var(--red-error); padding: 8px 12px; cursor: pointer; width: 100%; text-align: left; }
        #cable-context-menu button:hover { background-color: var(--red-error); color: white; }
        .workspace.ping-isolation-mode .device:not(.ping-active) { opacity: 0.1; pointer-events: none; }
        #cable-svg.ping-isolation-mode line:not(.ping-active) { opacity: 0.05; }
        .device.ping-active { box-shadow: 0 0 20px var(--primary-blue); border-color: var(--primary-blue); z-index: 1001; }
        #ping-overlay { position: absolute; bottom: 10px; left: 10px; width: calc(100% - 20px); max-width: 500px;  background: rgba(20, 20, 30, 0.85); border: 1px solid var(--border-color); backdrop-filter: blur(5px); border-radius: 8px; z-index: 1500; padding: 15px; display: none; flex-direction: column; box-sizing: border-box; }
        #ping-log-display { font-family: 'Courier New', Courier, monospace; color: white; font-size: 14px; height: 120px; overflow-y: auto; background-color: #111118; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        #ping-log-display p { margin: 0 0 5px 0; }
        #cancel-ping-btn { background-color: var(--red-error); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #device-info-modal .modal-content, #connection-modal .modal-content { max-width: 450px; }
        #device-info-modal h4, #connection-modal h4 { text-align: center; font-size: 1.2rem; }
        .info-grid { display: grid; grid-template-columns: 120px 1fr; gap: 12px; font-size: 1rem; margin-bottom: 20px; font-family: 'Courier New', Courier, monospace; }
        .info-grid span:first-child { font-weight: bold; text-align: right; color: var(--secondary-yellow); }
        .info-grid span:last-child { background-color: #111118; padding: 5px 8px; border-radius: 4px; word-break: break-all; }
        .vpn-control { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 10px 0 20px 0; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green-success); }
        input:focus + .slider { box-shadow: 0 0 1px var(--green-success); }
        input:checked + .slider:before { transform: translateX(26px); }
        #info-modal-close-btn { background-color: var(--red-error); margin-top: 10px; color:white; border:none; padding: 10px; border-radius: 8px; cursor:pointer; }
        .vpn-info-label, #info-vpn-ip { display: none; }
        .modal-filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .modal-filters button { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-light); border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .modal-filters button:hover { background-color: #3a3c53; }
        .modal-filters button.active { background-color: var(--primary-blue); border-color: var(--primary-blue); color: white; }
        #device-selection-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; flex-grow: 1; margin-bottom: 20px; min-height: 100px; }
        .device-list-item { background: var(--bg-dark); padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; border: 2px solid transparent; transition: border-color 0.2s, background-color 0.2s; font-size: 14px; }
        .device-list-item:hover { border-color: var(--primary-blue); }
        .device-list-item.selected { border-color: var(--secondary-yellow); background-color: #3a3c53; }
        .modal-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .modal-buttons button { padding: 10px 15px; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; flex-grow: 1; }
        #connect-selected-btn { background-color: var(--primary-blue); }
        #connect-all-btn { background-color: var(--green-success); }
        #cancel-connect-btn { background-color: var(--red-error); }
        
        /* ADDED: Styles for Help Button and Modal */
        #help-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background: var(--bg-light);
            color: var(--secondary-yellow);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 1002;
            transition: background-color 0.2s, color 0.2s;
        }
        #help-btn:hover {
            background-color: var(--secondary-yellow);
            color: var(--bg-dark);
        }
        #help-content {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        #help-content ul {
            list-style-type: none;
            padding-left: 0;
        }
        #help-content li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        #help-content li:last-child {
            border-bottom: none;
        }
        #help-content strong {
            color: var(--secondary-yellow);
        }
        #help-modal-close-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

    </style>
</head>
<body>

<div class="container">
    <button id="help-btn" title="Hướng dẫn sử dụng">?</button>

    <div class="workspace" id="workspace">
        <svg id="cable-svg"></svg>
        <div id="ddos-packet-container"></div>
        <div id="ping-overlay">
            <div id="ping-log-display"></div>
            <button id="cancel-ping-btn">Hủy Ping</button>
        </div>
    </div>
    <aside class="controls-panel">
        <h3>Bảng điều khiển</h3>
        <div class="io-buttons">
            <button id="import-btn">Nhập File 📂</button>
            <button id="export-btn">Xuất File 💾</button>
        </div>
        <h3>Nhật ký hệ thống</h3>
        <div class="log-panel"><ul id="log-list"></ul></div>
        <div class="control-buttons">
            <select id="add-device-select">
                <option value="pc">Thêm PC 💻</option>
                <option value="phone">Thêm Điện thoại 📱</option>
                <option value="router">Thêm Router 🖧</option>
                <option value="switch">Thêm Switch 🎚️</option>
                <option value="firewall">Thêm Tường lửa 🛡️</option>
                <option value="anti-ddos-system">Thêm Hệ thống Anti-DDoS 🛡️✨</option>
            </select>
            <button id="add-selected-device-btn">Thêm Thiết Bị</button>
            
            <hr>
            <button id="auto-ip-btn" title="Cấp IP cho các thiết bị chưa có IP và kết nối tới Router">Cấp IP tự động (DHCP)</button>
            <button id="add-ddos-btn" title="Tạo một server DDoS. Nối dây server này vào Router để bắt đầu tấn công.">Tấn công DDoS 💀</button>
        </div>
        <div class="batch-controls" style="color: green;">
            <h3>Thao tác hàng loạt</h3>
            <input type="number" id="multi-pc-count" placeholder="Số lượng" value="5" min="1">
            <button id="add-multi-pc-btn" style="color: white;background-color: #0d6efd;" >Thêm nhiều PC</button>
        </div>
        
    </aside>
</div>

<div id="connection-modal" class="modal-overlay">
    <div class="modal-content">
        <h4 id="modal-title">Kết nối thiết bị</h4>
        <div class="modal-filters" id="device-filter-buttons">
            <button data-filter="all" class="active">Tất cả</button>
            <button data-filter="pc">Chỉ PC</button>
            <button data-filter="phone">Chỉ Điện Thoại</button>
        </div>
        <div id="device-selection-list"></div>
        <div class="modal-buttons">
            <button id="connect-selected-btn">Kết nối mục đã chọn</button>
            <button id="connect-all-btn">Kết nối tất cả</button>
            <button id="cancel-connect-btn">Hủy</button>
        </div>
    </div>
</div>
<div id="device-info-modal" class="modal-overlay">
    <div class="modal-content">
        <h4 id="info-modal-title">Thông tin thiết bị</h4>
        <div class="info-grid">
            <span>Tên thiết bị:</span><span id="info-device-name"></span>
            <span>IP Private:</span><span id="info-private-ip"></span>
            <span>IP Public:</span><span id="info-public-ip"></span>
            <span class="vpn-info-label">IP Proxy/VPN:</span><span id="info-vpn-ip"></span>
        </div>
        <div class="vpn-control">
            <span><b>Proxy/VPN:</b></span>
            <label class="switch">
                <input type="checkbox" id="vpn-toggle">
                <span class="slider"></span>
            </label>
            <span id="vpn-status">Đang TẮT</span>
        </div>
        <button id="info-modal-close-btn">Đóng</button>
    </div>
</div>

<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <h4>Hướng Dẫn Sử Dụng</h4>
        <div id="help-content">
            <p>Chào mừng bạn đến với công cụ Mô phỏng Mạng!</p>
            <ul>
                <li><strong>Thêm Thiết Bị:</strong> Chọn một loại thiết bị từ menu thả xuống ở bảng điều khiển và nhấn "Thêm Thiết Bị".</li>
                <li><strong>Di Chuyển Thiết Bị:</strong> Nhấn và kéo phần thân của một thiết bị để di chuyển nó trong không gian làm việc.</li>
                <li><strong>Nối Dây:</strong> Di chuột vào thiết bị, sau đó nhấn và kéo biểu tượng liên kết (🔗) từ thiết bị này sang thiết bị khác.</li>
                <li><strong>Xóa Thiết Bị:</strong> Di chuột vào thiết bị và nhấn vào nút 'x' màu đỏ.</li>
                <li><strong>Xóa Kết Nối:</strong> Nhấp chuột phải vào một đường dây cáp và chọn "Xóa kết nối".</li>
                <li><strong>Ping:</strong> Trên PC hoặc Điện thoại, di chuột vào thiết bị và nhấn nút mũi tên (➤), sau đó nhấp vào thiết bị đích.</li>
                <li><strong>Xem Thông Tin / VPN:</strong> Nhấp đúp chuột vào PC hoặc Điện thoại để xem thông tin chi tiết và bật/tắt Proxy/VPN.</li>
                <li><strong>Cấp IP Tự Động:</strong> Nhấn nút "Cấp IP tự động (DHCP)" để các Router tự động cấp IP cho các thiết bị được kết nối.</li>
                <li><strong>Tấn Công DDoS:</strong> Thêm một "DDoS Server" và nối dây nó vào một Router để bắt đầu mô phỏng cuộc tấn công.</li>
            </ul>
        </div>
        <button id="help-modal-close-btn">Đã hiểu</button>
    </div>
</div>

<input type="file" id="import-file-input" style="display: none;" accept=".json">

<script>
document.addEventListener('DOMContentLoaded', () => {
    const workspace = document.getElementById('workspace');
    const cableSvg = document.getElementById('cable-svg');
    const ddosPacketContainer = document.getElementById('ddos-packet-container');
    const logList = document.getElementById('log-list');
    
    const addDeviceSelect = document.getElementById('add-device-select');
    const addSelectedDeviceBtn = document.getElementById('add-selected-device-btn');
    const addDdosBtn = document.getElementById('add-ddos-btn');
    
    const autoIpBtn = document.getElementById('auto-ip-btn');
    const addMultiPcBtn = document.getElementById('add-multi-pc-btn');
    const multiPcCountInput = document.getElementById('multi-pc-count');
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFileInput = document.getElementById('import-file-input');
    const pingOverlay = document.getElementById('ping-overlay');
    const pingLogDisplay = document.getElementById('ping-log-display');
    const cancelPingBtn = document.getElementById('cancel-ping-btn');
    const connectionModal = document.getElementById('connection-modal');
    const modalTitle = document.getElementById('modal-title');
    const deviceSelectionList = document.getElementById('device-selection-list');
    const connectSelectedBtn = document.getElementById('connect-selected-btn');
    const connectAllBtn = document.getElementById('connect-all-btn');
    const cancelConnectBtn = document.getElementById('cancel-connect-btn');
    const deviceFilterButtons = document.getElementById('device-filter-buttons');
    const deviceInfoModal = document.getElementById('device-info-modal');
    const infoModalTitle = document.getElementById('info-modal-title');
    const infoDeviceName = document.getElementById('info-device-name');
    const infoPrivateIp = document.getElementById('info-private-ip');
    const infoPublicIp = document.getElementById('info-public-ip');
    const vpnToggle = document.getElementById('vpn-toggle');
    const vpnStatus = document.getElementById('vpn-status');
    const infoModalCloseBtn = document.getElementById('info-modal-close-btn');

    // ADDED: Constants for the new help modal
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpModalCloseBtn = document.getElementById('help-modal-close-btn');

    let devices = {};
    let cables = {};
    let deviceCounter = 0;
    let cableCounter = 0;
    let draggedDevice = null;
    let offsetX, offsetY;
    let isPingMode = false;
    let pingInProgress = false;
    let pingSourceDevice = null;
    let pingTimeoutId = null;
    let ddosIntervals = {};

    let isConnecting = false;
    let connectionSourceId = null;
    let tempCableLine = null;

    const addLog = (message, type = 'info') => {
        const li = document.createElement('li');
        li.textContent = `> ${message}`;
        li.className = `log-${type}`;
        logList.prepend(li);
        if (logList.children.length > 200) {
            logList.removeChild(logList.lastChild);
        }
    };
    
    const stopDdosAnimation = (ddosId) => {
        if (ddosIntervals[ddosId]) {
            clearInterval(ddosIntervals[ddosId]);
            delete ddosIntervals[ddosId];
        }
    };

    const clearWorkspace = () => {
        Object.values(devices).forEach(d => {
            if (d.attackTimeoutId) clearTimeout(d.attackTimeoutId);
            workspace.removeChild(d.element);
        });
        cableSvg.innerHTML = '';
        ddosPacketContainer.innerHTML = '';
        Object.keys(ddosIntervals).forEach(stopDdosAnimation);
        devices = {};
        cables = {};
        ddosIntervals = {};
        logList.innerHTML = '';
        addLog("Không gian làm việc đã được dọn dẹp.", "info");
    };
    
    const createDeviceElement = (devData) => {
        const deviceElement = document.createElement('div');
        deviceElement.className = 'device';
        deviceElement.id = devData.id;
        deviceElement.style.left = devData.left;
        deviceElement.style.top = devData.top;

        if (devData.type === 'ddos') {
            deviceElement.classList.add('ddos-server');
        }

        const icons = { pc: '💻', phone: '📱', router: '🖧', switch: '🎚️', ddos: '💀', firewall: '🛡️', 'anti-ddos-system': '🛡️✨' };
        const icon = icons[devData.type] || '?';
        let ipFieldHtml = '';
        if (devData.type === 'router') {
            deviceElement.style.height = '110px';
            ipFieldHtml = '<div class="public-ip-display" title="IP Public">Chưa có IP</div>';
        } else if (devData.ipEnabled) {
            ipFieldHtml = `
                <input type="text" class="ip-input" placeholder="IP Private" value="${devData.privateIp || ''}">
                <div class="public-ip-on-device" title="IP Public (từ Router)">Chưa kết nối</div>
            `;
        } else {
             deviceElement.style.height = '110px';
        }
        deviceElement.innerHTML = `
            <button class="remove-btn" title="Xóa thiết bị">x</button>
            <button class="connect-btn" title="Nối dây tới thiết bị khác">🔗</button>
            ${ (devData.type === 'pc' || devData.type === 'phone') ? `<button class="ping-btn" title="Ping đến thiết bị khác">➤</button>` : '' }
            <div class="device-icon">${icon}</div>
            <div class="device-screen"></div>
            <div class="device-info">
                <p class="device-name">${devData.name}</p>
                ${ipFieldHtml}
            </div>
        `;
        deviceElement.querySelector('.remove-btn').addEventListener('click', e => { e.stopPropagation(); removeDevice(devData.id); });
        
        const connectBtn = deviceElement.querySelector('.connect-btn');
        if (connectBtn) connectBtn.addEventListener('mousedown', onConnectStart);
        
        const pingBtn = deviceElement.querySelector('.ping-btn');
        if (pingBtn) pingBtn.addEventListener('click', e => { e.stopPropagation(); startPing(devData.id); });
        
        const ipInput = deviceElement.querySelector('.ip-input');
        if (ipInput) ipInput.addEventListener('blur', handleManualIpChange);

        deviceElement.addEventListener('mousedown', onMouseDown);
        deviceElement.addEventListener('click', onDeviceClick);
        deviceElement.addEventListener('dblclick', onDeviceDoubleClick);
        return deviceElement;
    };

    const addDevice = (type, name, icon, ipEnabled = true) => {
        deviceCounter++;
        const deviceId = `device-${deviceCounter}`;
        const deviceName = `${name}-${deviceCounter}`;
        const workspaceRect = workspace.getBoundingClientRect();
        const deviceWidthWithMargin = 120;
        const deviceHeightWithMargin = 145;
        const itemsPerRow = Math.floor((workspaceRect.width - 20) / deviceWidthWithMargin) || 1;
        const currentDeviceCount = Object.keys(devices).length;
        const left = `${(currentDeviceCount % itemsPerRow) * deviceWidthWithMargin + 10}px`;
        const top = `${Math.floor(currentDeviceCount / itemsPerRow) * deviceHeightWithMargin + 10}px`;

        const devData = { id: deviceId, name: deviceName, type, ipEnabled, left, top, privateIp: null };
        const deviceElement = createDeviceElement(devData);
        workspace.appendChild(deviceElement);
        devices[deviceId] = { 
            element: deviceElement, name: deviceName, type: type, 
            ipEnabled: ipEnabled, privateIp: null, publicIp: null,
            vpnEnabled: false, vpnIp: null, connectedRouterId: null,
            isAttacking: false, attackTimeoutId: null
        };
        addLog(`Đã tạo ${deviceName}.`, 'info');
        updateAllDeviceStates();
        if (type === 'router' || type === 'switch') {
            showConnectionModal(deviceId, deviceName);
        }
    };
    
    const removeDevice = (deviceId) => {
        const device = devices[deviceId];
        if (!device) return;
        if (device.attackTimeoutId) clearTimeout(device.attackTimeoutId);
        if (device.type === 'ddos') {
            stopDdosAnimation(deviceId);
        }
        Object.keys(cables).forEach(cableId => {
            if (cables[cableId].from === deviceId || cables[cableId].to === deviceId) {
                removeCable(cableId, false);
            }
        });
        addLog(`Đã xóa ${device.name}.`, 'warn');
        workspace.removeChild(device.element);
        delete devices[deviceId];
        updateAllDeviceStates();
    };

    const findPathToRouter = (startDeviceId) => {
        const queue = [{ id: startDeviceId, path: [startDeviceId] }];
        const visited = new Set([startDeviceId]);
        while (queue.length > 0) {
            const { id: currentId } = queue.shift();
            const currentDevice = devices[currentId];
            if (currentDevice && currentDevice.type === 'router') {
                return { status: 'internet', routerId: currentId };
            }
            Object.values(cables).forEach(cable => {
                let neighborId = null;
                if (cable.from === currentId) neighborId = cable.to;
                else if (cable.to === currentId) neighborId = cable.from;
                if (neighborId && !visited.has(neighborId)) {
                    visited.add(neighborId);
                    queue.push({ id: neighborId });
                }
            });
        }
        if (Object.values(cables).some(c => c.from === startDeviceId || c.to === startDeviceId)) {
             return { status: 'lan_only', routerId: null };
        }
        return { status: 'disconnected', routerId: null };
    };
    
    const isRouterProtectedBy = (routerId, protectionType) => {
        return Object.values(cables).some(cable => {
            let neighborId = null;
            if (cable.from === routerId) neighborId = cable.to;
            else if (cable.to === routerId) neighborId = cable.from;

            if (neighborId && devices[neighborId] && devices[neighborId].type === protectionType) {
                return true;
            }
            return false;
        });
    };
    
    const isRouterScrubbed = (routerId) => isRouterProtectedBy(routerId, 'anti-ddos-system');
    const isRouterProtectedByFirewall = (routerId) => isRouterProtectedBy(routerId, 'firewall');

    const startDdosAnimation = (ddosId, routerId) => {
        if (ddosIntervals[ddosId]) return;
        const ddosDevice = devices[ddosId]?.element;
        const routerDevice = devices[routerId]?.element;
        if (!ddosDevice || !routerDevice) return;

        ddosIntervals[ddosId] = setInterval(() => {
            if (!devices[ddosId] || !devices[routerId]) {
                 stopDdosAnimation(ddosId);
                 return;
            }
            const ddosRect = ddosDevice.getBoundingClientRect();
            const routerRect = routerDevice.getBoundingClientRect();
            const workspaceRect = workspace.getBoundingClientRect();
            const startX = ddosRect.left + ddosRect.width / 2 - workspaceRect.left + (Math.random() - 0.5) * 40;
            const startY = ddosRect.top + ddosRect.height / 2 - workspaceRect.top + (Math.random() - 0.5) * 40;
            const endX = routerRect.left + routerRect.width / 2 - workspaceRect.left + (Math.random() - 0.5) * 50;
            const endY = routerRect.top + routerRect.height / 2 - workspaceRect.top + (Math.random() - 0.5) * 50;
            const packet = document.createElement('div');
            packet.className = 'ddos-packet';
            packet.style.left = `${startX}px`;
            packet.style.top = `${startY}px`;
            const translateX = endX - startX;
            const translateY = endY - startY;
            const distance = Math.sqrt(translateX*translateX + translateY*translateY);
            const duration = distance / (300 + Math.random() * 100);
            packet.style.setProperty('--tx', `${translateX}px`);
            packet.style.setProperty('--ty', `${translateY}px`);
            packet.style.animationDuration = `${Math.max(0.3, duration)}s`;
            ddosPacketContainer.appendChild(packet);
            packet.addEventListener('animationend', () => packet.remove());
        }, 80);
    };
    
    const updateDdosState = () => {
        document.querySelectorAll('.cable-under-ddos, .device-ddos-victim, .under-ddos, .ddos-protected').forEach(el => {
            el.classList.remove('cable-under-ddos', 'device-ddos-victim', 'under-ddos', 'ddos-protected');
        });

        const attackedRouterIds = new Set();
        const scrubbedRouterIds = new Set();

        Object.values(devices).filter(d => d.type === 'ddos').forEach(ddosServer => {
            const ddosId = ddosServer.element.id;
            const connection = Object.values(cables).find(c => c.from === ddosId || c.to === ddosId);
            
            let isActivelyAttacking = false;

            if (connection) {
                const neighborId = connection.from === ddosId ? connection.to : connection.from;
                const neighbor = devices[neighborId];

                if (neighbor && neighbor.type === 'router') {
                    if (isRouterScrubbed(neighborId)) {
                        scrubbedRouterIds.add(neighborId);
                        if (!ddosServer.isAttacking) {
                            addLog(`🛡️✨ Hệ thống Anti-DDoS đang lọc lưu lượng tấn công vào ${neighbor.name}.`, 'success');
                        }
                        startDdosAnimation(ddosId, neighborId);
                        isActivelyAttacking = true;

                    } else if (isRouterProtectedByFirewall(neighborId)) {
                        if (ddosServer.isAttacking) {
                            addLog(`🛡️ Tấn công vào ${neighbor.name} đã bị Tường lửa chặn!`, 'success');
                        }
                        isActivelyAttacking = false;

                    } else {
                        // Unprotected
                        attackedRouterIds.add(neighborId);
                        isActivelyAttacking = true;
                        if (!ddosServer.isAttacking) {
                            ddosServer.isAttacking = true;
                            const delay = Math.random() * 2000 + 2000;
                            addLog(`🔥 Server ${ddosServer.name} nhắm vào ${neighbor.name}. Tấn công sau ${(delay / 1000).toFixed(1)}s...`, 'warn');
                            
                            if (ddosServer.attackTimeoutId) clearTimeout(ddosServer.attackTimeoutId);
                            ddosServer.attackTimeoutId = setTimeout(() => {
                                if (!devices[ddosId] || !devices[neighborId]) return;
                                addLog(`🔥 BẮT ĐẦU TẤN CÔNG: ${ddosServer.name} -> ${neighbor.name}!`, 'error');
                                updateAllDeviceStates();
                            }, delay);
                        }
                        startDdosAnimation(ddosId, neighborId);
                    }
                }
            }
            
            if (!isActivelyAttacking) {
                if (ddosServer.isAttacking) addLog(`🛑 Cuộc tấn công từ ${ddosServer.name} đã dừng.`, 'warn');
                stopDdosAnimation(ddosId);
                if (ddosServer.attackTimeoutId) clearTimeout(ddosServer.attackTimeoutId);
                ddosServer.attackTimeoutId = null;
                ddosServer.isAttacking = false;
            } else {
                ddosServer.isAttacking = true;
            }
        });

        // Apply visual states based on the findings
        attackedRouterIds.forEach(routerId => devices[routerId].element.classList.add('under-ddos'));
        scrubbedRouterIds.forEach(routerId => devices[routerId].element.classList.add('ddos-protected'));
        
        Object.values(devices).forEach(device => {
            if (attackedRouterIds.has(device.connectedRouterId) && device.type !== 'router' && device.type !== 'switch') {
                device.element.classList.add('device-ddos-victim');
            }
        });

        Object.values(cables).forEach(cable => {
            const fromDevice = devices[cable.from];
            const toDevice = devices[cable.to];
            const isFromAffected = fromDevice && (attackedRouterIds.has(fromDevice.element.id) || fromDevice.element.classList.contains('device-ddos-victim'));
            const isToAffected = toDevice && (attackedRouterIds.has(toDevice.element.id) || toDevice.element.classList.contains('device-ddos-victim'));

            if (isFromAffected || isToAffected) {
                cable.element.classList.add('cable-under-ddos');
            }
        });
    };
    
    const updateAllDeviceStates = () => {
        Object.values(devices).forEach(d => {
            d.publicIp = null;
            d.connectedRouterId = null;
        });
        const allRouters = Object.values(devices).filter(dev => dev.type === 'router');
        allRouters.forEach(router => {
            if (!router.publicIp) {
                router.publicIp = `118.70.${Math.floor(Math.random() * 254) + 1}.${Math.floor(Math.random() * 254) + 1}`;
            }
            if(router.element.querySelector('.public-ip-display')) {
                router.element.querySelector('.public-ip-display').textContent = router.publicIp;
            }
            Object.entries(devices).forEach(([id, device]) => {
                if (findPathToRouter(id).routerId === router.element.id) {
                    device.publicIp = router.publicIp;
                    device.connectedRouterId = router.element.id;
                }
            });
        });
        Object.keys(devices).forEach(updateDeviceIpDisplayInWorkspace);
        
        checkForConflicts();
        updateDdosState();
        updateAllDeviceScreens();
        updateCablePositions();
    };

    const updateAllDeviceScreens = () => {
        Object.keys(devices).forEach(id => {
            const device = devices[id];
            if (device.element.classList.contains('ip-conflict') || 
                device.element.classList.contains('under-ddos') ||
                device.element.classList.contains('device-ddos-victim')) {
                if(device.element.classList.contains('under-ddos') || device.element.classList.contains('device-ddos-victim')) {
                       device.element.classList.add('has-connection');
                }
                return;
            }

            const screen = device.element.querySelector('.device-screen');
            if (!screen) return;
            
            const pathInfo = findPathToRouter(id);
            device.element.classList.remove('has-connection');
            screen.classList.remove('screen-internet', 'screen-lan-only');

            if (device.element.classList.contains('ddos-protected')) {
                 device.element.classList.add('has-connection');
                 screen.classList.add('screen-internet');
                 return;
            }

            if (pathInfo.status === 'internet') {
                device.element.classList.add('has-connection');
                screen.classList.add('screen-internet');
            } else if (pathInfo.status === 'lan_only') {
                device.element.classList.add('has-connection');
                screen.classList.add('screen-lan-only');
            }
        });
    }

    const exportState=()=>{if(Object.keys(devices).length===0){addLog("Không có gì để xuất. Hãy thêm thiết bị.","error");return}const e=Object.entries(devices).map(([e,t])=>({id:e,name:t.name,type:t.type,ipEnabled:t.ipEnabled,vpnEnabled:t.vpnEnabled,vpnIp:t.vpnIp,publicIp:t.type==="router"?t.publicIp:null,privateIp:t.privateIp,left:t.element.style.left,top:t.element.style.top})),t=Object.entries(cables).map(([e,t])=>({from:t.from,to:t.to})),o={deviceCounter,cableCounter,devices:e,cables:t},a=JSON.stringify(o,null,2),n=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(n),d=document.createElement("a");d.href=i,d.download="network-simulation.json",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i),addLog("Đã xuất trạng thái mạng ra file thành công!","success")},loadState=e=>{clearWorkspace();try{deviceCounter=e.deviceCounter||0,cableCounter=e.cableCounter||0,e.devices.forEach(e=>{const t=createDeviceElement(e);workspace.appendChild(t),devices[e.id]={element:t,name:e.name,type:e.type,ipEnabled:e.ipEnabled,vpnEnabled:e.vpnEnabled,vpnIp:e.vpnIp,publicIp:e.publicIp,privateIp:e.privateIp,connectedRouterId:null}}),e.cables.forEach(e=>createCable(e.from,e.to)),updateAllDeviceStates(),addLog("Đã tải trạng thái mạng từ file thành công!","success")}catch(e){console.error("Lỗi khi tải trạng thái:",e),addLog("File trạng thái không hợp lệ hoặc bị lỗi.","error"),clearWorkspace()}},handleManualIpChange=e=>{const t=e.target.closest(".device").id,o=devices[t];if(!o)return;const a=e.target.value.trim();o.privateIp!==a&&(addLog(`Đã cập nhật IP của ${o.name} thành ${a||"chưa có"}.`,"info"),o.privateIp=a||null,updateAllDeviceStates())},createCable=(e,t)=>{if(!devices[e]||!devices[t])return;if(Object.values(cables).some(o=>(o.from===e&&o.to===t)||(o.from===t&&o.to===e)))return void addLog(`Kết nối giữa ${devices[e].name} và ${devices[t].name} đã tồn tại!`,"warn");cableCounter++;const o=`cable-${cableCounter}`,a=document.createElementNS("http://www.w3.org/2000/svg","line");a.id=o,a.setAttribute("stroke","var(--cable-color)"),a.setAttribute("stroke-width","4"),a.addEventListener("contextmenu",e=>{e.preventDefault(),showCableContextMenu(e.clientX,e.clientY,o)}),cableSvg.appendChild(a),cables[o]={from:e,to:t,element:a},addLog(`Đã nối ${devices[e].name} và ${devices[t].name}.`,"success"),updateAllDeviceStates()},removeCable=(e,t=!0)=>{const o=cables[e];if(o){const a=devices[o.from]?.name||"thiết bị đã xóa",n=devices[o.to]?.name||"thiết bị đã xóa";addLog(`Đã xóa kết nối giữa ${a} và ${n}.`,"warn"),o.element.parentNode&&cableSvg.removeChild(o.element),delete cables[e],t&&updateAllDeviceStates()}},updateCablePositions=()=>{Object.values(cables).forEach(e=>{const t=devices[e.from]?.element,o=devices[e.to]?.element;if(t&&o){const a=t.getBoundingClientRect(),n=o.getBoundingClientRect(),i=workspace.getBoundingClientRect(),d=a.left+a.width/2-i.left,r=a.top+a.height/2-i.top,c=n.left+n.width/2-i.left,s=n.top+n.height/2-i.top;e.element.setAttribute("x1",d),e.element.setAttribute("y1",r),e.element.setAttribute("x2",c),e.element.setAttribute("y2",s)}})},updateDeviceIpDisplayInWorkspace=e=>{const t=devices[e];if(!t||!t.ipEnabled)return;const o=t.element.querySelector(".public-ip-on-device");if(!o)return;t.vpnEnabled?(t.vpnIp||(t.vpnIp=`45.8.${Math.floor(254*Math.random())+1}.${Math.floor(254*Math.random())+1}`),o.textContent=t.vpnIp,o.style.color="var(--green-success)",o.title="IP Proxy/VPN"):(o.textContent=t.publicIp||"Chưa kết nối",o.style.color="var(--secondary-yellow)",o.title="IP Public (từ Router)")},findPath=(e,t)=>{const o=[{id:e,path:[e]}],a=new Set([e]);for(;o.length>0;){const{id:n,path:i}=o.shift();if(n===t)return i;Object.values(cables).forEach(t=>{let d=null;t.from===n?d=t.to:t.to===n&&(d=t.from),d&&!a.has(d)&&(a.add(d),o.push({id:d,path:[...i,d]}))})}return null},checkForConflicts=()=>{const e={};Object.values(devices).forEach(t=>{t.element.classList.remove("ip-conflict");const e=t.element.querySelector(".device-screen");e&&e.classList.remove("screen-ip-conflict-visuals")}),Object.entries(devices).forEach(([t,o])=>{o.privateIp&&(e[o.privateIp]||(e[o.privateIp]=[]),e[o.privateIp].push(t))}),Object.values(e).forEach(e=>{if(e.length>1){const t=devices[e[0]].privateIp;addLog(`Phát hiện trùng IP: ${t}`,"error"),e.forEach(e=>{const t=devices[e];if(t){t.element.classList.add("ip-conflict");const e=t.element.querySelector(".device-screen");e&&(e.className="device-screen screen-ip-conflict-visuals",t.element.classList.add("has-connection"))}})}})},runDhcp=()=>{addLog("Bắt đầu tiến trình cấp IP (DHCP)...","warn");const e=Object.entries(devices).filter(([,e])=>"router"===e.type);e.forEach(([e,t],o)=>{let a=`192.168.${o+1}.`,n=10;const i=Object.entries(devices).filter(([t,o])=>findPathToRouter(t).routerId===e);i.forEach(([,e])=>{if(e.ipEnabled&&!e.privateIp){let t;do{t=a+n++}while(Object.values(devices).some(e=>e.privateIp===t));e.privateIp=t;const o=e.element.querySelector(".ip-input");o&&(o.value=e.privateIp),addLog(`Đã cấp IP ${e.privateIp} cho ${e.name}`,"success")}})}),updateAllDeviceStates(),addLog("Hoàn tất cấp IP.","success")};

    function onDeviceDoubleClick(e){const t=e.currentTarget.id;"pc"===devices[t].type||"phone"===devices[t].type?showDeviceInfoModal(t):void 0}

    function onDeviceClick(e){
        if(pingInProgress || e.target.closest(".ip-input, .connect-btn")) return;
        const deviceId = e.currentTarget.id;
        if(isPingMode) {
            if (pingSourceDevice && pingSourceDevice !== deviceId) {
                executePing(pingSourceDevice, deviceId);
            }
        }
    }

    function onMouseDown(e){
        if(isConnecting || pingInProgress || e.target.closest(".ip-input, .remove-btn, .ping-btn, .connect-btn")) return;
        draggedDevice=e.currentTarget;
        draggedDevice.style.cursor="grabbing";
        draggedDevice.style.zIndex=1000;
        const t=draggedDevice.getBoundingClientRect();
        offsetX=e.clientX-t.left,offsetY=e.clientY-t.top;
        document.addEventListener("mousemove",onMouseMove);
        document.addEventListener("mouseup",onMouseUp);
    }
    
    function onConnectStart(e) {
        e.stopPropagation(); 
        isConnecting = true;
        connectionSourceId = e.target.closest('.device').id;

        const sourceDevice = devices[connectionSourceId].element;
        const workspaceRect = workspace.getBoundingClientRect();
        const sourceRect = sourceDevice.getBoundingClientRect();

        const startX = sourceRect.left + sourceRect.width / 2 - workspaceRect.left;
        const startY = sourceRect.top + sourceRect.height / 2 - workspaceRect.top;

        tempCableLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
        tempCableLine.setAttribute('stroke', 'var(--secondary-yellow)');
        tempCableLine.setAttribute('stroke-width', '4');
        tempCableLine.setAttribute('stroke-dasharray', '5 5');
        tempCableLine.setAttribute('x1', startX);
        tempCableLine.setAttribute('y1', startY);
        tempCableLine.setAttribute('x2', startX);
        tempCableLine.setAttribute('y2', startY);
        cableSvg.appendChild(tempCableLine);

        document.addEventListener('mousemove', onConnectMove);
        document.addEventListener('mouseup', onConnectEnd, { once: true });
    }

    function onConnectMove(e) {
        if (!isConnecting || !tempCableLine) return;
        const workspaceRect = workspace.getBoundingClientRect();
        const mouseX = e.clientX - workspaceRect.left;
        const mouseY = e.clientY - workspaceRect.top;
        tempCableLine.setAttribute('x2', mouseX);
        tempCableLine.setAttribute('y2', mouseY);
    }

    function onConnectEnd(e) {
        if (tempCableLine) {
            tempCableLine.remove();
            tempCableLine = null;
        }

        const targetElement = document.elementFromPoint(e.clientX, e.clientY)?.closest('.device');

        if (targetElement && devices[targetElement.id] && targetElement.id !== connectionSourceId) {
            createCable(connectionSourceId, targetElement.id);
        }
        
        isConnecting = false;
        connectionSourceId = null;
        document.removeEventListener('mousemove', onConnectMove);
    }

    function onMouseMove(e){if(!draggedDevice)return;const t=workspace.getBoundingClientRect();let o=e.clientX-offsetX-t.left,a=e.clientY-offsetY-t.top;o=Math.max(0,Math.min(o,workspace.clientWidth-draggedDevice.offsetWidth)),a=Math.max(0,Math.min(a,workspace.clientHeight-draggedDevice.offsetHeight)),draggedDevice.style.left=`${o}px`,draggedDevice.style.top=`${a}px`,updateCablePositions()}function onMouseUp(){draggedDevice&&(draggedDevice.style.cursor="grab",draggedDevice.style.zIndex="auto"),draggedDevice=null,document.removeEventListener("mousemove",onMouseMove),document.removeEventListener("mouseup",onMouseUp)}const startPing=e=>{if(isConnecting||pingInProgress)return void addLog("Không thể Ping khi đang thực hiện hành động khác.","error");isPingMode=!0,pingSourceDevice=e,Object.values(devices).forEach(e=>e.element.classList.remove("ping-source")),devices[e].element.classList.add("ping-source"),workspace.style.cursor="pointer",addLog(`Chế độ Ping: Từ ${devices[e].name}. Chọn thiết bị đích.`,"warn")},cancelPingSelection=()=>{isPingMode=!1,pingSourceDevice&&devices[pingSourceDevice]&&devices[pingSourceDevice].element.classList.remove("ping-source"),pingSourceDevice=null,workspace.style.cursor="default",addLog("Đã hủy chế độ chọn Ping.","info")},endPingProcess=()=>{pingInProgress&&(pingTimeoutId&&clearTimeout(pingTimeoutId),pingTimeoutId=null,pingInProgress=!1,workspace.classList.remove("ping-isolation-mode"),cableSvg.classList.remove("ping-isolation-mode"),document.querySelectorAll(".ping-active").forEach(e=>e.classList.remove("ping-active")),pingOverlay.style.display="none",pingLogDisplay.innerHTML="",addLog("Tiến trình Ping đã kết thúc.","info"))},animatePingPackets=(e,t=1e3)=>{for(let o=0;o<e.length-1;o++){const a=e[o],n=e[o+1],i=Object.values(cables).find(e=>(e.from===a&&e.to===n)||(e.from===n&&e.to===a));i&&setTimeout(()=>{if(!pingInProgress)return;const e=i.element.cloneNode();e.removeAttribute("id"),e.classList.add("cable-ping"),e.style.animationDuration=`${t/1e3}s`,cableSvg.appendChild(e),e.addEventListener("animationend",()=>{e.parentNode===cableSvg&&cableSvg.removeChild(e)});const o=i.element.getAttribute("x1"),a=i.element.getAttribute("y1"),n=i.element.getAttribute("x2"),d=i.element.getAttribute("y2"),r=document.createElementNS("http://www.w3.org/2000/svg","text");r.textContent="ping",r.classList.add("ping-packet-text");const c=document.createElementNS("http://www.w3.org/2000/svg","animateMotion");c.setAttribute("dur",`${t/1e3}s`),c.setAttribute("fill","freeze"),c.setAttribute("path",`M${o},${a} L${n},${d}`),r.appendChild(c),cableSvg.appendChild(r),setTimeout(()=>{r.parentNode===cableSvg&&cableSvg.removeChild(r)},t)},o*t)}},executePing=(e,t)=>{const o=devices[e],a=devices[t],n=a.privateIp||a.name;cancelPingSelection(),addLog(`Bắt đầu ping từ ${o.name} đến ${a.name}...`,"info");const i=findPath(e,t);pingInProgress=!0,workspace.classList.add("ping-isolation-mode"),cableSvg.classList.add("ping-isolation-mode"),pingOverlay.style.display="flex",pingLogDisplay.innerHTML="";const d=(e,t="white")=>{const o=document.createElement("p");o.textContent=e,o.style.color=t,pingLogDisplay.appendChild(o),pingLogDisplay.scrollTop=pingLogDisplay.scrollHeight};if(i){i.forEach(e=>devices[e].element.classList.add("ping-active"));for(let e=0;e<i.length-1;e++){const t=Object.values(cables).find(o=>(o.from===i[e]&&o.to===i[e+1])||(o.from===i[e+1]&&o.to===i[e]));t&&t.element.classList.add("ping-active")}d(`Pinging ${a.name} [${n}] with 32 bytes of data:`);let e=0;const t=1500,r=()=>{if(!pingInProgress)return;if(e>=4)return d(`\nPing statistics for ${n}:`),d("     Packets: Sent = 4, Received = 4, Lost = 0 (0% loss)","var(--secondary-yellow)"),void(pingTimeoutId=setTimeout(endPingProcess,2e3));const o=2*(i.length-1)+Math.floor(10*Math.random());d(`Reply from ${n}: bytes=32 time=${o}ms TTL=128`,"var(--green-success)"),animatePingPackets(i,1e3),e++,pingTimeoutId=setTimeout(r,t)};r()}else o.element.classList.add("ping-active"),a.element.classList.add("ping-active"),d(`Pinging ${a.name} [${n}]...`),d("Request timed out.","var(--red-error)"),pingTimeoutId=setTimeout(()=>{pingInProgress&&(d("Request timed out.","var(--red-error)"),d(`\nPing statistics for ${n}:`),d("     Packets: Sent = 2, Received = 0, Lost = 2 (100% loss)","var(--secondary-yellow)"),pingTimeoutId=setTimeout(endPingProcess,3e3))},1500)},showConnectionModal=(e,t)=>{modalTitle.textContent=`Kết nối ${t} với các thiết bị`,connectionModal.dataset.newDeviceId=e,deviceFilterButtons.querySelector("button.active")?.classList.remove("active"),deviceFilterButtons.querySelector('button[data-filter="all"]').classList.add("active"),populateDeviceList("all"),connectionModal.style.display="flex"},hideConnectionModal=()=>{connectionModal.style.display="none"},isAlreadyConnectedToSwitchOrRouter=e=>Object.values(cables).some(t=>{let o=null;if(t.from===e)o=t.to;else{if(t.to!==e)return!1;o=t.from}return o&&devices[o]&&("switch"===devices[o].type||"router"===devices[o].type)}),populateDeviceList=e=>{deviceSelectionList.innerHTML="";const t=Object.entries(devices).filter(([e,t])=>("pc"===t.type||"phone"===t.type)&&!isAlreadyConnectedToSwitchOrRouter(e)).filter(([,t])=>"all"===e||t.type===e);if(0===t.length)return void(deviceSelectionList.innerHTML='<p style="text-align:center; width:100%; padding: 20px 0;">Không có thiết bị nào phù hợp.</p>');t.forEach(([e,t])=>{const o=document.createElement("div");o.className="device-list-item",o.textContent=`${t.name} ${"pc"===t.type?"💻":"📱"}`,o.dataset.deviceId=e,o.addEventListener("click",()=>o.classList.toggle("selected")),deviceSelectionList.appendChild(o)})},showDeviceInfoModal=e=>{const t=devices[e];t&&(deviceInfoModal.dataset.currentDeviceId=e,infoModalTitle.textContent=`Thông tin ${t.name}`,infoDeviceName.textContent=t.name,infoPrivateIp.textContent=t.privateIp||"Chưa được cấp",vpnToggle.checked=t.vpnEnabled,updateVpnDisplay(e),deviceInfoModal.style.display="flex")},hideDeviceInfoModal=()=>{deviceInfoModal.style.display="none"},updateVpnDisplay=e=>{const t=devices[e];if(!t)return;const o=deviceInfoModal.querySelector(".vpn-info-label"),a=deviceInfoModal.querySelector("#info-vpn-ip");infoPublicIp.textContent=t.publicIp||"Không có Internet",infoPublicIp.style.color=t.publicIp?"var(--secondary-yellow)":"var(--red-error)",t.vpnEnabled?(t.vpnIp||(t.vpnIp=`45.8.${Math.floor(254*Math.random())+1}.${Math.floor(254*Math.random())+1}`),a.textContent=t.vpnIp,a.style.color="var(--green-success)",o.style.display="",a.style.display="",vpnStatus.textContent="Đang BẬT"):(o.style.display="none",a.style.display="none",vpnStatus.textContent="Đang TẮT")},showCableContextMenu=(e,t,o)=>{removeCableContextMenu();const a=document.createElement("div");a.id="cable-context-menu",a.style.left=`${e}px`,a.style.top=`${t}px`,a.innerHTML="<button>Xóa kết nối</button>",document.body.appendChild(a),a.querySelector("button").addEventListener("click",()=>{removeCable(o),removeCableContextMenu()})},removeCableContextMenu=()=>{document.getElementById("cable-context-menu")?.remove()};

    // --- EVENT LISTENERS ---
    addSelectedDeviceBtn.addEventListener('click', () => {
        const selectedType = addDeviceSelect.value;
        switch (selectedType) {
            case 'pc': addDevice('pc', 'PC', '💻'); break;
            case 'phone': addDevice('phone', 'Phone', '📱'); break;
            case 'router': addDevice('router', 'Router', '🖧', false); break;
            case 'switch': addDevice('switch', 'Switch', '🎚️', false); break;
            case 'firewall': addDevice('firewall', 'Firewall', '🛡️', false); break;
            case 'anti-ddos-system': addDevice('anti-ddos-system', 'Anti-DDoS', '🛡️✨', false); break;
        }
    });

    addDdosBtn.addEventListener('click', () => addDevice('ddos', 'DDoS Server', '💀', false));
    
    autoIpBtn.addEventListener('click', runDhcp);
    addMultiPcBtn.addEventListener('click', () => {
        const count = parseInt(multiPcCountInput.value, 10);
        if (isNaN(count) || count <= 0) { addLog("Vui lòng nhập số lượng hợp lệ.", "error"); return; }
        addLog(`Đang tạo ${count} PC...`, "warn");
        for (let i = 0; i < count; i++) addDevice('pc', 'PC', '💻');
        addLog(`Đã tạo xong ${count} PC.`, "success");
    });
    
    exportBtn.addEventListener('click', exportState);
    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => { try { const state = JSON.parse(event.target.result); loadState(state); } catch (error) { addLog("Lỗi: Không thể đọc file JSON.", "error"); } };
        reader.readAsText(file);
        e.target.value = null;
    });

    cancelPingBtn.addEventListener('click', endPingProcess);
    cancelConnectBtn.addEventListener('click', hideConnectionModal);
    infoModalCloseBtn.addEventListener('click', hideDeviceInfoModal);

    // ADDED: Event listeners for the help modal
    helpBtn.addEventListener('click', () => { helpModal.style.display = 'flex'; });
    helpModalCloseBtn.addEventListener('click', () => { helpModal.style.display = 'none'; });
    helpModal.addEventListener('click', (e) => { if (e.target === helpModal) { helpModal.style.display = 'none'; } });


    vpnToggle.addEventListener('change', (e) => {
        const deviceId = deviceInfoModal.dataset.currentDeviceId;
        if (!deviceId || !devices[deviceId]) return;
        devices[deviceId].vpnEnabled = e.target.checked;
        addLog(`VPN/Proxy trên ${devices[deviceId].name} đã được ${e.target.checked ? "BẬT" : "TẮT"}.`, 'warn');
        updateVpnDisplay(deviceId);
        updateDeviceIpDisplayInWorkspace(deviceId);
    });

    connectSelectedBtn.addEventListener('click', () => {
        const newDeviceId = connectionModal.dataset.newDeviceId;
        if (!newDeviceId) return;
        const selectedItems = deviceSelectionList.querySelectorAll('.device-list-item.selected');
        addLog(`Đang kết nối ${devices[newDeviceId].name} với ${selectedItems.length} thiết bị...`, 'info');
        selectedItems.forEach(item => createCable(newDeviceId, item.dataset.deviceId));
        hideConnectionModal();
    });
    connectAllBtn.addEventListener('click', () => {
        const newDeviceId = connectionModal.dataset.newDeviceId;
        if (!newDeviceId) return;
        const allItems = deviceSelectionList.querySelectorAll('.device-list-item');
        addLog(`Đang kết nối ${devices[newDeviceId].name} với tất cả ${allItems.length} thiết bị...`, 'info');
        allItems.forEach(item => createCable(newDeviceId, item.dataset.deviceId));
        hideConnectionModal();
    });
    deviceFilterButtons.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') {
            deviceFilterButtons.querySelector('button.active')?.classList.remove('active');
            e.target.classList.add('active');
            populateDeviceList(e.target.dataset.filter);
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#cable-context-menu') && !e.target.closest('#cable-svg line')) {
            removeCableContextMenu();
        }
    });
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            if (helpModal.style.display === 'flex') { helpModal.style.display = 'none'; return; }
            if (pingInProgress) { endPingProcess(); return; }
            if (isPingMode) { cancelPingSelection(); return; }
            hideConnectionModal();
            hideDeviceInfoModal();
            removeCableContextMenu();
        }
    });

    new ResizeObserver(updateCablePositions).observe(workspace);
    addLog("Chào mừng! Nhấn nút '?' để xem hướng dẫn.", "success");
});
</script>

</body>
</html>