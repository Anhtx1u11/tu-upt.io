<!DOCTYPE html>
<html lang="vi">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>MÃ´ Phá»ng Máº¡ng ToÃ n Diá»‡n - DDoS & VLAN Effects</title>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-dark: #1e1e2f;
Â  Â  Â  Â  Â  Â  --bg-light: #27293d;
Â  Â  Â  Â  Â  Â  --primary-blue: #0d6efd;
Â  Â  Â  Â  Â  Â  --secondary-yellow: #ffc107;
Â  Â  Â  Â  Â  Â  --text-light: #e0e0e0;
Â  Â  Â  Â  Â  Â  --border-color: #44475a;
Â  Â  Â  Â  Â  Â  --red-error: #e53935;
Â  Â  Â  Â  Â  Â  --green-success: #43a047;
Â  Â  Â  Â  Â  Â  --purple-action: #6f42c1;
Â  Â  Â  Â  Â  Â  --cable-color: #78909c;
Â  Â  Â  Â  Â  Â  --export-color: #20c997;
Â  Â  Â  Â  Â  Â  --import-color: #17a2b8;
Â  Â  Â  Â  Â  Â  --ddos-color: #b71c1c;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* VLAN Colors */
Â  Â  Â  Â  Â  Â  --vlan-color-1: #e91e63;
Â  Â  Â  Â  Â  Â  --vlan-color-2: #9c27b0;
Â  Â  Â  Â  Â  Â  --vlan-color-3: #3f51b5;
Â  Â  Â  Â  Â  Â  --vlan-color-4: #03a9f4;
Â  Â  Â  Â  Â  Â  --vlan-color-5: #009688;
Â  Â  Â  Â  Â  Â  --vlan-color-6: #8bc34a;
Â  Â  Â  Â  Â  Â  --vlan-color-7: #ff9800;
Â  Â  Â  Â  Â  Â  --vlan-color-8: #795548;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes blink-error {
Â  Â  Â  Â  Â  Â  0% { box-shadow: 0 0 10px var(--red-error); }
Â  Â  Â  Â  Â  Â  50% { box-shadow: none; }
Â  Â  Â  Â  Â  Â  100% { box-shadow: 0 0 10px var(--red-error); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes highlight-success {
Â  Â  Â  Â  Â  Â  0% { box-shadow: 0 0 12px var(--green-success); }
Â  Â  Â  Â  Â  Â  100% { box-shadow: none; }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes data-flow { to { stroke-dashoffset: 0; } }

Â  Â  Â  Â  @keyframes ddos-pulse {
Â  Â  Â  Â  Â  Â  0% { box-shadow: 0 0 18px var(--red-error), inset 0 0 10px rgba(255, 82, 82, 0.5); }
Â  Â  Â  Â  Â  Â  50% { box-shadow: 0 0 8px var(--red-error), inset 0 0 4px rgba(255, 82, 82, 0.2); }
Â  Â  Â  Â  Â  Â  100% { box-shadow: 0 0 18px var(--red-error), inset 0 0 10px rgba(255, 82, 82, 0.5); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes ddos-packet-flow {
Â  Â  Â  Â  Â  Â  from { opacity: 1; }
Â  Â  Â  Â  Â  Â  to { opacity: 0; transform: translate(var(--tx), var(--ty)); }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @keyframes ddos-cable-flow {
Â  Â  Â  Â  Â  Â  to { stroke-dashoffset: -100; }
Â  Â  Â  Â  }


Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Roboto', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-dark);
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  width: 95%; max-width: 1600px; height: 90vh;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-light); border-radius: 15px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  .workspace {
Â  Â  Â  Â  Â  Â  flex-grow: 1; position: relative; overflow: hidden;
Â  Â  Â  Â  Â  Â  background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
Â  Â  Â  Â  Â  Â  background-size: 20px 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #cable-svg {
Â  Â  Â  Â  Â  Â  position: absolute; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%; pointer-events: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  #cable-svg line {
Â  Â  Â  Â  Â  Â  pointer-events: all; cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: opacity 0.4s ease-in-out, stroke 0.3s linear;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #ddos-packet-container {
Â  Â  Â  Â  Â  Â  position: absolute; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .ddos-packet {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 6px;
Â  Â  Â  Â  Â  Â  height: 6px;
Â  Â  Â  Â  Â  Â  background-color: var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 8px var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  animation-name: ddos-packet-flow;
Â  Â  Â  Â  Â  Â  animation-timing-function: linear;
Â  Â  Â  Â  Â  Â  animation-fill-mode: forwards;
Â  Â  Â  Â  }


Â  Â  Â  Â  .cable-ping {
Â  Â  Â  Â  Â  Â  stroke: var(--secondary-yellow); stroke-width: 4px;
Â  Â  Â  Â  Â  Â  stroke-dasharray: 8 12; stroke-dashoffset: 200;
Â  Â  Â  Â  Â  Â  animation: data-flow 1.5s linear forwards;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .cable-under-ddos {
Â  Â  Â  Â  Â  Â  stroke: var(--red-error);
Â  Â  Â  Â  Â  Â  stroke-dasharray: 10 15;
Â  Â  Â  Â  Â  Â  animation: ddos-cable-flow 1s linear infinite;
Â  Â  Â  Â  }

        /* --- NEW CSS CLASS --- */
        .cable-scrubbing {
            stroke: var(--primary-blue);
            stroke-width: 5px;
            stroke-dasharray: 10 10;
            animation: ddos-cable-flow 0.8s linear infinite;
        }


Â  Â  Â  Â  .ping-packet-text {
Â  Â  Â  Â  Â  Â  font-family: 'Courier New', Courier, monospace;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  fill: var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  text-anchor: middle;
Â  Â  Â  Â  }


Â  Â  Â  Â  .device {
Â  Â  Â  Â  Â  Â  background-color: var(--bg-dark); border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px; padding: 8px; text-align: center;
Â  Â  Â  Â  Â  Â  width: 100px; height: 125px;Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; justify-content: space-around;
Â  Â  Â  Â  Â  Â  position: absolute; user-select: none; cursor: grab;
Â  Â  Â  Â  Â  Â  transition: box-shadow 0.3s, border-color 0.3s, opacity 0.4s ease-in-out, height 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .device:hover { border-color: var(--primary-blue); }
Â  Â  Â  Â  .device.selected-for-connection { border-color: var(--secondary-yellow); box-shadow: 0 0 15px var(--secondary-yellow); }
Â  Â  Â  Â  .device.ip-conflict { border-style: dashed; animation: blink-error 1.5s infinite; }
Â  Â  Â  Â  .device.highlight { animation: highlight-success 1s ease-out; }
Â  Â  Â  Â  .device.ping-source { border-color: var(--primary-blue); box-shadow: 0 0 15px var(--primary-blue); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .device.ddos-server {
Â  Â  Â  Â  Â  Â  border-color: var(--ddos-color);
Â  Â  Â  Â  Â  Â  background-color: #3f2a3a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .device.under-ddos {
Â  Â  Â  Â  Â  Â  animation: ddos-pulse 1s infinite;
Â  Â  Â  Â  Â  Â  border-color: var(--red-error);
Â  Â  Â  Â  }
Â  Â  Â  Â  .device.ddos-protected {
Â  Â  Â  Â  Â  Â  border-color: var(--primary-blue);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px var(--primary-blue), inset 0 0 8px rgba(13, 110, 253, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .device.vpn-protected {
Â  Â  Â  Â  Â  Â  border-color: var(--green-success);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px var(--green-success), inset 0 0 8px rgba(67, 160, 71, 0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  .device.device-ddos-victim {
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  border-color: var(--red-error);
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .device-icon { font-size: 2rem; }
Â  Â  Â  Â  .device-name { font-weight: bold; margin: 4px 0; font-size: 14px; }
Â  Â  Â  Â  .ip-input {
Â  Â  Â  Â  Â  Â  width: 90%; background-color: var(--bg-light); border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  color: var(--text-light); border-radius: 4px; padding: 3px;
Â  Â  Â  Â  Â  Â  text-align: center; font-family: 'Courier New', Courier, monospace; font-size: 11px;
Â  Â  Â  Â  Â  Â  margin-bottom: 3px;
Â  Â  Â  Â  Â  Â  cursor: text;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .public-ip-display {
Â  Â  Â  Â  Â  Â  font-family: 'Courier New', Courier, monospace;
Â  Â  Â  Â  Â  Â  font-size: 11px; color: var(--secondary-yellow); padding: 3px;
Â  Â  Â  Â  Â  Â  background-color: #111118; border-radius: 4px; width: 90%;
Â  Â  Â  Â  Â  Â  margin: 0 auto; min-height: 19px; box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  .public-ip-on-device {
Â  Â  Â  Â  Â  Â  font-family: 'Courier New', Courier, monospace;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  color: var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  background-color: #2c2e43;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  padding: 2px 4px;
Â  Â  Â  Â  Â  Â  margin-top: 2px;
Â  Â  Â  Â  Â  Â  max-width: 90%;
Â  Â  Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-overflow: ellipsis;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  min-height: 17px;
Â  Â  Â  Â  Â  Â  transition: color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .device-screen {
Â  Â  Â  Â  Â  Â  position: absolute; top: 25px; left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%); width: 65px; height: 40px;
Â  Â  Â  Â  Â  Â  background-color: rgba(0,0,0,0.7); border-radius: 4px;
Â  Â  Â  Â  Â  Â  z-index: 2; pointer-events: none; transition: all 0.5s;
Â  Â  Â  Â  Â  Â  opacity: 0; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .device.has-connection .device-screen { opacity: 1; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .screen-internet {
Â  Â  Â  Â  Â  Â  background-image: url('https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png');
Â  Â  Â  Â  Â  Â  background-size: contain; background-repeat: no-repeat;
Â  Â  Â  Â  Â  Â  background-position: center; background-color: #fff;
Â  Â  Â  Â  }

Â  Â  Â  Â  .screen-internet-icon {
Â  Â  Â  Â  Â  Â  background-color: var(--bg-dark);
Â  Â  Â  Â  }
Â  Â  Â  Â  .screen-internet-icon::before {
Â  Â  Â  Â  Â  Â  content: "ğŸŒ";
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  color: var(--primary-blue);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .screen-lan-only::before {
Â  Â  Â  Â  Â  Â  content: "NO INTERNET\A USE LAN"; white-space: pre-wrap;
Â  Â  Â  Â  Â  Â  color: var(--secondary-yellow); font-size: 8px; font-weight: bold;
Â  Â  Â  Â  Â  Â  text-align: center; line-height: 1.2;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .screen-ip-conflict-visuals {
Â  Â  Â  Â  Â  Â  background-color: var(--red-error) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .screen-ip-conflict-visuals::before {
Â  Â  Â  Â  Â  Â  content: "TRÃ™NG IP";
Â  Â  Â  Â  Â  Â  color: var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 2px black;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .device.under-ddos .device-screen {
Â  Â  Â  Â  Â  Â  Â opacity: 1;
Â  Â  Â  Â  Â  Â  Â background-color: var(--ddos-color) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .device.under-ddos .device-screen::before {
Â  Â  Â  Â  Â  Â  content: "OVERLOAD!\A(DDoS)"; white-space: pre-wrap;
Â  Â  Â  Â  Â  Â  color: white; font-size: 12px; font-weight: bold;
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 2px black;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .device.device-ddos-victim .device-screen {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  background: var(--red-error) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .device.device-ddos-victim .device-screen::before {
Â  Â  Â  Â  Â  Â  content: "Máº¤T Káº¾T Ná»I";
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .remove-btn, .ping-btn, .connect-btn {
Â  Â  Â  Â  Â  Â  position: absolute; color: white; border: none; border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 20px; height: 20px; font-weight: bold; cursor: pointer;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  opacity: 0; transition: opacity 0.2s; z-index: 10;
Â  Â  Â  Â  }
Â  Â  Â  Â  .remove-btn { top: -7px; right: -7px; background: var(--red-error); }
Â  Â  Â  Â  .ping-btn { bottom: -7px; right: -7px; background: var(--primary-blue); font-size: 12px; }
Â  Â  Â  Â  .connect-btn { bottom: -7px; left: -7px; background: var(--secondary-yellow); font-size: 12px; }
Â  Â  Â  Â  .device:hover .remove-btn, .device:hover .ping-btn, .device:hover .connect-btn { opacity: 1; }

Â  Â  Â  Â  .controls-panel { flex-basis: 350px; flex-shrink: 0; background-color: var(--bg-dark); padding: 20px; border-left: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; }
Â  Â  Â  Â  .controls-panel h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
Â  Â  Â  Â  .io-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
Â  Â  Â  Â  .io-buttons button { flex-grow: 1; padding: 10px; font-size: 1rem; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
Â  Â  Â  Â  #export-btn { background-color: var(--import-color); }
Â  Â  Â  Â  #import-btn { background-color: var(--export-color); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .control-buttons button, .batch-controls button { width: 100%; padding: 12px; font-size: 1rem; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: background-color 0.2s, opacity 0.2s; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .controls-panel select {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  background-color: var(--bg-light);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  -moz-appearance: none;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e0e0e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  Â  Â  Â  background-position: right 1rem center;
Â  Â  Â  Â  Â  Â  background-size: 1em;
Â  Â  Â  Â  }

Â  Â  Â  Â  #add-selected-device-btn { background-color: var(--primary-blue); }
Â  Â  Â  Â  #auto-ip-btn { background-color: var(--green-success); }
Â  Â  Â  Â  #add-ddos-btn { background-color: var(--ddos-color); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .batch-controls { margin-top: 15px; }
Â  Â  Â  Â  .batch-controls input { width: calc(100% - 22px); padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-light); color: var(--text-light); font-size: 1rem; }
Â  Â  Â  Â  .log-panel { margin-top: 20px; flex-grow: 1; background-color: #111118; border-radius: 8px; padding: 15px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 13px; min-height: 150px; }
Â  Â  Â  Â  #log-list { list-style-type: none; padding: 0; margin: 0; }
Â  Â  Â  Â  #log-list li { padding: 4px 0; border-bottom: 1px dashed var(--border-color); word-break: break-word; }
Â  Â  Â  Â  .log-success { color: var(--green-success); }
Â  Â  Â  Â  .log-error { color: var(--red-error); font-weight: bold; }
Â  Â  Â  Â  .log-info { color: var(--text-light); }
Â  Â  Â  Â  .log-warn { color: var(--secondary-yellow); }
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
Â  Â  Â  Â  .modal-content { background: var(--bg-light); padding: 25px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 80vh; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
Â  Â  Â  Â  .modal-content h4 { margin-top: 0; color: var(--secondary-yellow); }
Â  Â  Â  Â  #cable-context-menu { position: absolute; background-color: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; z-index: 3000; }
Â  Â  Â  Â  #cable-context-menu button { background: none; border: none; color: var(--red-error); padding: 8px 12px; cursor: pointer; width: 100%; text-align: left; }
Â  Â  Â  Â  #cable-context-menu button:hover { background-color: var(--red-error); color: white; }
Â  Â  Â  Â  .workspace.ping-isolation-mode .device:not(.ping-active) { opacity: 0.1; pointer-events: none; }
Â  Â  Â  Â  #cable-svg.ping-isolation-mode line:not(.ping-active) { opacity: 0.05; }
Â  Â  Â  Â  .device.ping-active { box-shadow: 0 0 20px var(--primary-blue); border-color: var(--primary-blue); z-index: 1001; }
Â  Â  Â  Â  #ping-overlay { position: absolute; bottom: 10px; left: 10px; width: calc(100% - 20px); max-width: 500px;Â  background: rgba(20, 20, 30, 0.85); border: 1px solid var(--border-color); backdrop-filter: blur(5px); border-radius: 8px; z-index: 1500; padding: 15px; display: none; flex-direction: column; box-sizing: border-box; }
Â  Â  Â  Â  #ping-log-display { font-family: 'Courier New', Courier, monospace; color: white; font-size: 14px; height: 120px; overflow-y: auto; background-color: #111118; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
Â  Â  Â  Â  #ping-log-display p { margin: 0 0 5px 0; }
Â  Â  Â  Â  #cancel-ping-btn { background-color: var(--red-error); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
Â  Â  Â  Â  #device-info-modal .modal-content, #connection-modal .modal-content { max-width: 450px; }
Â  Â  Â  Â  #device-info-modal h4, #connection-modal h4 { text-align: center; font-size: 1.2rem; }
Â  Â  Â  Â  .info-grid { display: grid; grid-template-columns: 120px 1fr; gap: 12px; font-size: 1rem; margin-bottom: 20px; font-family: 'Courier New', Courier, monospace; }
Â  Â  Â  Â  .info-grid span:first-child { font-weight: bold; text-align: right; color: var(--secondary-yellow); }
Â  Â  Â  Â  .info-grid span:last-child { background-color: #111118; padding: 5px 8px; border-radius: 4px; word-break: break-all; }
Â  Â  Â  Â  .vpn-control { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 10px 0 20px 0; }
Â  Â  Â  Â  .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
Â  Â  Â  Â  .switch input { opacity: 0; width: 0; height: 0; }
Â  Â  Â  Â  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
Â  Â  Â  Â  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
Â  Â  Â  Â  input:checked + .slider { background-color: var(--green-success); }
Â  Â  Â  Â  input:focus + .slider { box-shadow: 0 0 1px var(--green-success); }
Â  Â  Â  Â  input:checked + .slider:before { transform: translateX(26px); }
Â  Â  Â  Â  #info-modal-close-btn { background-color: var(--red-error); margin-top: 10px; color:white; border:none; padding: 10px; border-radius: 8px; cursor:pointer; }
Â  Â  Â  Â  .vpn-info-label, #info-vpn-ip { display: none; }
Â  Â  Â  Â  .modal-filters { display: flex; gap: 10px; margin-bottom: 15px; }
Â  Â  Â  Â  .modal-filters button { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-light); border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
Â  Â  Â  Â  .modal-filters button:hover { background-color: #3a3c53; }
Â  Â  Â  Â  .modal-filters button.active { background-color: var(--primary-blue); border-color: var(--primary-blue); color: white; }
Â  Â  Â  Â  #device-selection-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; flex-grow: 1; margin-bottom: 20px; min-height: 100px; }
Â  Â  Â  Â  .device-list-item { background: var(--bg-dark); padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; border: 2px solid transparent; transition: border-color 0.2s, background-color 0.2s; font-size: 14px; }
Â  Â  Â  Â  .device-list-item:hover { border-color: var(--primary-blue); }
Â  Â  Â  Â  .device-list-item.selected { border-color: var(--secondary-yellow); background-color: #3a3c53; }
Â  Â  Â  Â  .modal-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
Â  Â  Â  Â  .modal-buttons button { padding: 10px 15px; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; flex-grow: 1; }
Â  Â  Â  Â  #connect-selected-btn { background-color: var(--primary-blue); }
Â  Â  Â  Â  #connect-all-btn { background-color: var(--green-success); }
Â  Â  Â  Â  #cancel-connect-btn { background-color: var(--red-error); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #help-btn {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 15px;
Â  Â  Â  Â  Â  Â  right: 15px;
Â  Â  Â  Â  Â  Â  width: 30px;
Â  Â  Â  Â  Â  Â  height: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  background: var(--bg-light);
Â  Â  Â  Â  Â  Â  color: var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  z-index: 1002;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-btn:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--secondary-yellow);
Â  Â  Â  Â  Â  Â  color: var(--bg-dark);
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-content {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  line-height: 1.6;
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-content ul {
Â  Â  Â  Â  Â  Â  list-style-type: none;
Â  Â  Â  Â  Â  Â  padding-left: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-content li {
Â  Â  Â  Â  Â  Â  padding: 8px 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px dashed var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-content li:last-child {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-content strong {
Â  Â  Â  Â  Â  Â  color: var(--secondary-yellow);
Â  Â  Â  Â  }
Â  Â  Â  Â  #help-modal-close-btn {
Â  Â  Â  Â  Â  Â  background-color: var(--primary-blue);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* VLAN Modal Styles */
Â  Â  Â  Â  #vlan-modal .modal-content {
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-section {
Â  Â  Â  Â  Â  Â  background-color: var(--bg-dark);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-section h5 {
Â  Â  Â  Â  Â  Â  margin: 0 0 10px 0;
Â  Â  Â  Â  Â  Â  color: var(--primary-blue);
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding-bottom: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #vlan-creator {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #vlan-creator input {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-light);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #vlan-creator button {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  background-color: var(--green-success);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  #vlan-port-assignments {
Â  Â  Â  Â  Â  Â  max-height: 250px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-port-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 8px 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px dashed var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-port-item:last-child {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-port-item span {
Â  Â  Â  Â  Â  Â  font-family: 'Courier New', Courier, monospace;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-port-item select {
Â  Â  Â  Â  Â  Â  background-color: var(--bg-light);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vlan-modal-buttons {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  Â .vlan-modal-buttons button {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â }
Â  Â  </style>
</head>
<body>

<div class="container">
Â  Â  <button id="help-btn" title="HÆ°á»›ng dáº«n sá»­ dá»¥ng">?</button>

Â  Â  <div class="workspace" id="workspace">
Â  Â  Â  Â  <svg id="cable-svg"></svg>
Â  Â  Â  Â  <div id="ddos-packet-container"></div>
Â  Â  Â  Â  <div id="ping-overlay">
Â  Â  Â  Â  Â  Â  <div id="ping-log-display"></div>
Â  Â  Â  Â  Â  Â  <button id="cancel-ping-btn">Há»§y Ping</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <aside class="controls-panel">
Â  Â  Â  Â  <h3>Báº£ng Ä‘iá»u khiá»ƒn</h3>
Â  Â  Â  Â  <div class="io-buttons">
Â  Â  Â  Â  Â  Â  <button id="import-btn">Nháº­p File ğŸ“‚</button>
Â  Â  Â  Â  Â  Â  <button id="export-btn">Xuáº¥t File ğŸ’¾</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â <h3>Nháº­t kÃ½ há»‡ thá»‘ng</h3>
Â  Â  Â  Â  <div class="log-panel"><ul id="log-list"></ul></div>
Â  Â  Â  Â  <div class="control-buttons">
Â  Â  Â  Â  Â  Â  <select id="add-device-select">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="pc">ThÃªm PC ğŸ’»</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="phone">ThÃªm Äiá»‡n thoáº¡i ğŸ“±</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="router">ThÃªm Router ğŸ–§</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="router-v2">ThÃªm Router V2 (VLAN) ğŸ–§âœ¨</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="switch">ThÃªm Switch ğŸšï¸</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="firewall">ThÃªm TÆ°á»ng lá»­a ğŸ›¡ï¸</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="anti-ddos-system">ThÃªm Há»‡ thá»‘ng Anti-DDoS ğŸ›¡ï¸âœ¨</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <button id="add-selected-device-btn">ThÃªm Thiáº¿t Bá»‹</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  <button id="auto-ip-btn" title="Cáº¥p IP cho cÃ¡c thiáº¿t bá»‹ chÆ°a cÃ³ IP vÃ  káº¿t ná»‘i tá»›i Router">Cáº¥p IP tá»± Ä‘á»™ng (DHCP)</button>
Â  Â  Â  Â  Â  Â  <button id="add-ddos-btn" title="Táº¡o má»™t server DDoS. Ná»‘i dÃ¢y server nÃ y vÃ o Router Ä‘á»ƒ báº¯t Ä‘áº§u táº¥n cÃ´ng.">Táº¥n cÃ´ng DDoS ğŸ’€</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="batch-controls">
Â  Â  Â  Â  Â  Â  <h3>Thao tÃ¡c hÃ ng loáº¡t</h3>
Â  Â  Â  Â  Â  Â  <input type="number" id="multi-pc-count" placeholder="Sá»‘ lÆ°á»£ng" value="5" min="1">
Â  Â  Â  Â  Â  Â  <button id="add-multi-pc-btn" style="background-color: blue;color: white;">ThÃªm nhiá»u PC</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  </aside>
</div>

<div id="connection-modal" class="modal-overlay">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h4 id="modal-title">Káº¿t ná»‘i thiáº¿t bá»‹</h4>
Â  Â  Â  Â  <div class="modal-filters" id="device-filter-buttons">
Â  Â  Â  Â  Â  Â  <button data-filter="all" class="active">Táº¥t cáº£</button>
Â  Â  Â  Â  Â  Â  <button data-filter="pc">Chá»‰ PC</button>
Â  Â  Â  Â  Â  Â  <button data-filter="phone">Chá»‰ Äiá»‡n Thoáº¡i</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="device-selection-list"></div>
Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  <button id="connect-selected-btn">Káº¿t ná»‘i má»¥c Ä‘Ã£ chá»n</button>
Â  Â  Â  Â  Â  Â  <button id="connect-all-btn">Káº¿t ná»‘i táº¥t cáº£</button>
Â  Â  Â  Â  Â  Â  <button id="cancel-connect-btn">Há»§y</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="device-info-modal" class="modal-overlay">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h4 id="info-modal-title">ThÃ´ng tin thiáº¿t bá»‹</h4>
Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  <span>TÃªn thiáº¿t bá»‹:</span><span id="info-device-name"></span>
Â  Â  Â  Â  Â  Â  <span>IP Private:</span><span id="info-private-ip"></span>
Â  Â  Â  Â  Â  Â  <span>IP Public:</span><span id="info-public-ip"></span>
Â  Â  Â  Â  Â  Â  <span class="vpn-info-label">IP Proxy/VPN:</span><span id="info-vpn-ip"></span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="vpn-control">
Â  Â  Â  Â  Â  Â  <span><b>VPN Chá»‘ng DDoS:</b></span>
Â  Â  Â  Â  Â  Â  <label class="switch">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="vpn-toggle">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="slider"></span>
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <span id="vpn-status">Äang Táº®T</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="info-modal-close-btn">ÄÃ³ng</button>
Â  Â  </div>
</div>

<div id="vlan-modal" class="modal-overlay">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h4 id="vlan-modal-title">Quáº£n lÃ½ VLAN</h4>
Â  Â  Â  Â  <div class="vlan-section">
Â  Â  Â  Â  Â  Â  <h5>Táº¡o VLAN Má»›i</h5>
Â  Â  Â  Â  Â  Â  <div id="vlan-creator">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="vlan-id-input" placeholder="VLAN ID (vd: 10)">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="vlan-name-input" placeholder="TÃªn VLAN (vd: Sales)">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-vlan-btn">ThÃªm</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="vlan-section">
Â  Â  Â  Â  Â  Â  <h5>GÃ¡n Cá»•ng vÃ o VLAN</h5>
Â  Â  Â  Â  Â  Â  <div id="vlan-port-assignments">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="vlan-modal-buttons modal-buttons">
Â  Â  Â  Â  Â  Â  <button id="save-vlan-config" style="background-color: var(--green-success);">LÆ°u Cáº¥u HÃ¬nh</button>
Â  Â  Â  Â  Â  Â  <button id="cancel-vlan-config" style="background-color: var(--red-error);">Há»§y</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>


<div id="help-modal" class="modal-overlay">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h4>HÆ°á»›ng Dáº«n Sá»­ Dá»¥ng</h4>
Â  Â  Â  Â  <div id="help-content">
Â  Â  Â  Â  Â  Â  <p>ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i cÃ´ng cá»¥ MÃ´ phá»ng Máº¡ng!</p>
Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>ThÃªm Thiáº¿t Bá»‹:</strong> Chá»n má»™t loáº¡i thiáº¿t bá»‹ tá»« menu tháº£ xuá»‘ng á»Ÿ báº£ng Ä‘iá»u khiá»ƒn vÃ  nháº¥n "ThÃªm Thiáº¿t Bá»‹".</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Di Chuyá»ƒn Thiáº¿t Bá»‹:</strong> Nháº¥n vÃ  kÃ©o pháº§n thÃ¢n cá»§a má»™t thiáº¿t bá»‹ Ä‘á»ƒ di chuyá»ƒn nÃ³ trong khÃ´ng gian lÃ m viá»‡c.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Ná»‘i DÃ¢y:</strong> Di chuá»™t vÃ o thiáº¿t bá»‹, sau Ä‘Ã³ nháº¥n vÃ  kÃ©o biá»ƒu tÆ°á»£ng liÃªn káº¿t (ğŸ”—) tá»« thiáº¿t bá»‹ nÃ y sang thiáº¿t bá»‹ khÃ¡c.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>XÃ³a Thiáº¿t Bá»‹:</strong> Di chuá»™t vÃ o thiáº¿t bá»‹ vÃ  nháº¥n vÃ o nÃºt 'x' mÃ u Ä‘á».</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>XÃ³a Káº¿t Ná»‘i:</strong> Nháº¥p chuá»™t pháº£i vÃ o má»™t Ä‘Æ°á»ng dÃ¢y cÃ¡p vÃ  chá»n "XÃ³a káº¿t ná»‘i".</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Ping:</strong> TrÃªn PC hoáº·c Äiá»‡n thoáº¡i, di chuá»™t vÃ o thiáº¿t bá»‹ vÃ  nháº¥n nÃºt mÅ©i tÃªn (â¤), sau Ä‘Ã³ nháº¥p vÃ o thiáº¿t bá»‹ Ä‘Ã­ch.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Xem ThÃ´ng Tin / VPN:</strong> Nháº¥p Ä‘Ãºp chuá»™t vÃ o PC hoáº·c Äiá»‡n thoáº¡i Ä‘á»ƒ xem thÃ´ng tin chi tiáº¿t vÃ  báº­t/táº¯t VPN Chá»‘ng DDoS.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Quáº£n lÃ½ VLAN:</strong> Nháº¥p Ä‘Ãºp vÃ o má»™t <strong>Router V2</strong> Ä‘á»ƒ má»Ÿ báº£ng cáº¥u hÃ¬nh VLAN.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Cáº¥p IP Tá»± Äá»™ng:</strong> Nháº¥n nÃºt "Cáº¥p IP tá»± Ä‘á»™ng (DHCP)" Ä‘á»ƒ cÃ¡c Router tá»± Ä‘á»™ng cáº¥p IP cho cÃ¡c thiáº¿t bá»‹ Ä‘Æ°á»£c káº¿t ná»‘i.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Táº¥n CÃ´ng DDoS:</strong> ThÃªm má»™t "DDoS Server" vÃ  ná»‘i dÃ¢y nÃ³ vÃ o má»™t Router Ä‘á»ƒ báº¯t Ä‘áº§u mÃ´ phá»ng cuá»™c táº¥n cÃ´ng.</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="help-modal-close-btn">ÄÃ£ hiá»ƒu</button>
Â  Â  </div>
</div>

<input type="file" id="import-file-input" style="display: none;" accept=".json">

<script>
document.addEventListener('DOMContentLoaded', () => {
Â  Â  // --- DOM Element References ---
Â  Â  const workspace = document.getElementById('workspace');
Â  Â  const cableSvg = document.getElementById('cable-svg');
Â  Â  const ddosPacketContainer = document.getElementById('ddos-packet-container');
Â  Â  const logList = document.getElementById('log-list');
Â  Â Â 
Â  Â  const addDeviceSelect = document.getElementById('add-device-select');
Â  Â  const addSelectedDeviceBtn = document.getElementById('add-selected-device-btn');
Â  Â  const addDdosBtn = document.getElementById('add-ddos-btn');
Â  Â Â 
Â  Â  const autoIpBtn = document.getElementById('auto-ip-btn');
Â  Â  const addMultiPcBtn = document.getElementById('add-multi-pc-btn');
Â  Â  const multiPcCountInput = document.getElementById('multi-pc-count');
Â  Â  const exportBtn = document.getElementById('export-btn');
Â  Â  const importBtn = document.getElementById('import-btn');
Â  Â  const importFileInput = document.getElementById('import-file-input');

Â  Â  const pingOverlay = document.getElementById('ping-overlay');
Â  Â  const pingLogDisplay = document.getElementById('ping-log-display');
Â  Â  const cancelPingBtn = document.getElementById('cancel-ping-btn');

Â  Â  const connectionModal = document.getElementById('connection-modal');
Â  Â  const modalTitle = document.getElementById('modal-title');
Â  Â  const deviceSelectionList = document.getElementById('device-selection-list');
Â  Â  const connectSelectedBtn = document.getElementById('connect-selected-btn');
Â  Â  const connectAllBtn = document.getElementById('connect-all-btn');
Â  Â  const cancelConnectBtn = document.getElementById('cancel-connect-btn');
Â  Â  const deviceFilterButtons = document.getElementById('device-filter-buttons');

Â  Â  const deviceInfoModal = document.getElementById('device-info-modal');
Â  Â  const infoModalTitle = document.getElementById('info-modal-title');
Â  Â  const infoDeviceName = document.getElementById('info-device-name');
Â  Â  const infoPrivateIp = document.getElementById('info-private-ip');
Â  Â  const infoPublicIp = document.getElementById('info-public-ip');
Â  Â  const vpnToggle = document.getElementById('vpn-toggle');
Â  Â  const vpnStatus = document.getElementById('vpn-status');
Â  Â  const infoModalCloseBtn = document.getElementById('info-modal-close-btn');

Â  Â  const vlanModal = document.getElementById('vlan-modal');
Â  Â  const vlanModalTitle = document.getElementById('vlan-modal-title');
Â  Â  const vlanIdInput = document.getElementById('vlan-id-input');
Â  Â  const vlanNameInput = document.getElementById('vlan-name-input');
Â  Â  const addVlanBtn = document.getElementById('add-vlan-btn');
Â  Â  const vlanPortAssignments = document.getElementById('vlan-port-assignments');
Â  Â  const saveVlanConfigBtn = document.getElementById('save-vlan-config');
Â  Â  const cancelVlanConfigBtn = document.getElementById('cancel-vlan-config');

Â  Â  const helpBtn = document.getElementById('help-btn');
Â  Â  const helpModal = document.getElementById('help-modal');
Â  Â  const helpModalCloseBtn = document.getElementById('help-modal-close-btn');

Â  Â  // --- State Variables ---
Â  Â  let devices = {};
Â  Â  let cables = {};
Â  Â  let idCounter = 0;
Â  Â  let deviceCounters = {};
Â  Â  let cableCounter = 0;
Â  Â Â 
Â  Â  let draggedDevice = null;
Â  Â  let offsetX, offsetY;
Â  Â  let isPingMode = false;
Â  Â  let pingInProgress = false;
Â  Â  let pingSourceDevice = null;
Â  Â  let pingTimeoutId = null;
Â  Â  let ddosIntervals = {};

Â  Â  let isConnecting = false;
Â  Â  let connectionSourceId = null;
Â  Â  let tempCableLine = null;
Â  Â Â 
Â  Â  const vlanColors = [
Â  Â  Â  Â  '--vlan-color-1', '--vlan-color-2', '--vlan-color-3', '--vlan-color-4',
Â  Â  Â  Â  '--vlan-color-5', '--vlan-color-6', '--vlan-color-7', '--vlan-color-8'
Â  Â  ];
Â  Â Â 
Â  Â  // --- Core Functions ---
Â  Â  const addLog = (message, type = 'info') => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.textContent = `> ${message}`;
Â  Â  Â  Â  li.className = `log-${type}`;
Â  Â  Â  Â  logList.prepend(li);
Â  Â  Â  Â  if (logList.children.length > 200) {
Â  Â  Â  Â  Â  Â  logList.removeChild(logList.lastChild);
Â  Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const stopDdosAnimation = (ddosId) => {
Â  Â  Â  Â  if (ddosIntervals[ddosId]) {
Â  Â  Â  Â  Â  Â  clearInterval(ddosIntervals[ddosId]);
Â  Â  Â  Â  Â  Â  delete ddosIntervals[ddosId];
Â  Â  Â  Â  }
Â  Â  };

Â  Â  const clearWorkspace = () => {
Â  Â  Â  Â  Object.values(devices).forEach(d => {
Â  Â  Â  Â  Â  Â  if (d.attackTimeoutId) clearTimeout(d.attackTimeoutId);
Â  Â  Â  Â  Â  Â  workspace.removeChild(d.element);
Â  Â  Â  Â  });
Â  Â  Â  Â  cableSvg.innerHTML = '';
Â  Â  Â  Â  ddosPacketContainer.innerHTML = '';
Â  Â  Â  Â  Object.keys(ddosIntervals).forEach(stopDdosAnimation);
Â  Â  Â  Â  devices = {};
Â  Â  Â  Â  cables = {};
Â  Â  Â  Â  ddosIntervals = {};
Â  Â  Â  Â  idCounter = 0;
Â  Â  Â  Â  deviceCounters = {};
Â  Â  Â  Â  cableCounter = 0;
Â  Â  Â  Â  logList.innerHTML = '';
Â  Â  Â  Â  addLog("KhÃ´ng gian lÃ m viá»‡c Ä‘Ã£ Ä‘Æ°á»£c dá»n dáº¹p.", "info");
Â  Â  };
Â  Â Â 
Â  Â  const createDeviceElement = (devData) => {
Â  Â  Â  Â  const deviceElement = document.createElement('div');
Â  Â  Â  Â  deviceElement.className = 'device';
Â  Â  Â  Â  deviceElement.id = devData.id;
Â  Â  Â  Â  deviceElement.style.left = devData.left;
Â  Â  Â  Â  deviceElement.style.top = devData.top;

Â  Â  Â  Â  if (devData.type === 'ddos') {
Â  Â  Â  Â  Â  Â  deviceElement.classList.add('ddos-server');
Â  Â  Â  Â  }

Â  Â  Â  Â  const icons = { pc: 'ğŸ’»', phone: 'ğŸ“±', router: 'ğŸ–§', 'router-v2': 'ğŸ–§âœ¨', switch: 'ğŸšï¸', ddos: 'ğŸ’€', firewall: 'ğŸ›¡ï¸', 'anti-ddos-system': 'ğŸ›¡ï¸âœ¨' };
Â  Â  Â  Â  const icon = icons[devData.type] || '?';
Â  Â  Â  Â  let ipFieldHtml = '';
Â  Â  Â  Â  if (devData.type === 'router' || devData.type === 'router-v2') {
Â  Â  Â  Â  Â  Â  deviceElement.style.height = '110px';
Â  Â  Â  Â  Â  Â  ipFieldHtml = '<div class="public-ip-display" title="IP Public">ChÆ°a cÃ³ IP</div>';
Â  Â  Â  Â  } else if (devData.ipEnabled) {
Â  Â  Â  Â  Â  Â  ipFieldHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="ip-input" placeholder="IP Private" value="${devData.privateIp || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="public-ip-on-device" title="IP Public (tá»« Router)">ChÆ°a káº¿t ná»‘i</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â deviceElement.style.height = '110px';
Â  Â  Â  Â  }
Â  Â  Â  Â  deviceElement.innerHTML = `
Â  Â  Â  Â  Â  Â  <button class="remove-btn" title="XÃ³a thiáº¿t bá»‹">x</button>
Â  Â  Â  Â  Â  Â  <button class="connect-btn" title="Ná»‘i dÃ¢y tá»›i thiáº¿t bá»‹ khÃ¡c">ğŸ”—</button>
Â  Â  Â  Â  Â  Â  ${ (devData.type === 'pc' || devData.type === 'phone') ? `<button class="ping-btn" title="Ping Ä‘áº¿n thiáº¿t bá»‹ khÃ¡c">â¤</button>` : '' }
Â  Â  Â  Â  Â  Â  <div class="device-icon">${icon}</div>
Â  Â  Â  Â  Â  Â  <div class="device-screen"></div>
Â  Â  Â  Â  Â  Â  <div class="device-info">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="device-name">${devData.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  ${ipFieldHtml}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  deviceElement.querySelector('.remove-btn').addEventListener('click', e => { e.stopPropagation(); removeDevice(devData.id); });
Â  Â  Â  Â  deviceElement.querySelector('.connect-btn').addEventListener('mousedown', onConnectStart);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const pingBtn = deviceElement.querySelector('.ping-btn');
Â  Â  Â  Â  if (pingBtn) pingBtn.addEventListener('click', e => { e.stopPropagation(); startPing(devData.id); });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const ipInput = deviceElement.querySelector('.ip-input');
Â  Â  Â  Â  if (ipInput) ipInput.addEventListener('blur', handleManualIpChange);

Â  Â  Â  Â  deviceElement.addEventListener('mousedown', onMouseDown);
Â  Â  Â  Â  deviceElement.addEventListener('click', onDeviceClick);
Â  Â  Â  Â  deviceElement.addEventListener('dblclick', onDeviceDoubleClick);
Â  Â  Â  Â  return deviceElement;
Â  Â  };

Â  Â  const addDevice = (type, name, ipEnabled = true) => {
Â  Â  Â  Â  idCounter++;
Â  Â  Â  Â  const deviceId = `device-${idCounter}`;

Â  Â  Â  Â  if (!deviceCounters[type]) {
Â  Â  Â  Â  Â  Â  deviceCounters[type] = 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  deviceCounters[type]++;
Â  Â  Â  Â  const deviceName = `${name}-${deviceCounters[type]}`;

Â  Â  Â  Â  const workspaceRect = workspace.getBoundingClientRect();
Â  Â  Â  Â  const deviceWidthWithMargin = 120;
Â  Â  Â  Â  const deviceHeightWithMargin = 145;
Â  Â  Â  Â  const itemsPerRow = Math.floor((workspaceRect.width - 20) / deviceWidthWithMargin) || 1;
Â  Â  Â  Â  const currentDeviceCount = Object.keys(devices).length;
Â  Â  Â  Â  const left = `${(currentDeviceCount % itemsPerRow) * deviceWidthWithMargin + 10}px`;
Â  Â  Â  Â  const top = `${Math.floor(currentDeviceCount / itemsPerRow) * deviceHeightWithMargin + 10}px`;

Â  Â  Â  Â  const devData = { id: deviceId, name: deviceName, type, ipEnabled, left, top, privateIp: null };
Â  Â  Â  Â  const deviceElement = createDeviceElement(devData);
Â  Â  Â  Â  workspace.appendChild(deviceElement);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const deviceObject = {Â 
Â  Â  Â  Â  Â  Â  element: deviceElement, name: deviceName, type: type,Â 
Â  Â  Â  Â  Â  Â  ipEnabled: ipEnabled, privateIp: null, publicIp: null,
Â  Â  Â  Â  Â  Â  vpnEnabled: false, vpnIp: null, connectedRouterId: null,
Â  Â  Â  Â  Â  Â  isAttacking: false, attackTimeoutId: null
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (type === 'router-v2') {
Â  Â  Â  Â  Â  Â  deviceObject.vlans = []; // Array of {id, name}
Â  Â  Â  Â  Â  Â  deviceObject.vlanAssignments = {}; // { cableId: vlanId }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  devices[deviceId] = deviceObject;

Â  Â  Â  Â  addLog(`ÄÃ£ táº¡o ${deviceName}.`, 'info');
Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  Â  Â  if (type === 'router' || type === 'router-v2' || type === 'switch') {
Â  Â  Â  Â  Â  Â  showConnectionModal(deviceId, deviceName);
Â  Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const removeDevice = (deviceId) => {
Â  Â  Â  Â  const device = devices[deviceId];
Â  Â  Â  Â  if (!device) return;
Â  Â  Â  Â  if (device.attackTimeoutId) clearTimeout(device.attackTimeoutId);
Â  Â  Â  Â  if (device.type === 'ddos') {
Â  Â  Â  Â  Â  Â  stopDdosAnimation(deviceId);
Â  Â  Â  Â  }
Â  Â  Â  Â  Object.keys(cables).forEach(cableId => {
Â  Â  Â  Â  Â  Â  if (cables[cableId].from === deviceId || cables[cableId].to === deviceId) {
Â  Â  Â  Â  Â  Â  Â  Â  removeCable(cableId, false); // false to prevent recursive update calls
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  addLog(`ÄÃ£ xÃ³a ${device.name}.`, 'warn');
Â  Â  Â  Â  workspace.removeChild(device.element);
Â  Â  Â  Â  delete devices[deviceId];
Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  };
Â  Â Â 
Â  Â  const isRouterProtectedBy = (routerId, protectionType) => {
Â  Â  Â  Â  return Object.values(cables).some(cable => {
Â  Â  Â  Â  Â  Â  let neighborId = null;
Â  Â  Â  Â  Â  Â  if (cable.from === routerId) neighborId = cable.to;
Â  Â  Â  Â  Â  Â  else if (cable.to === routerId) neighborId = cable.from;

Â  Â  Â  Â  Â  Â  if (neighborId && devices[neighborId] && devices[neighborId].type === protectionType) {
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â  Â  const isRouterScrubbed = (routerId) => isRouterProtectedBy(routerId, 'anti-ddos-system');
Â  Â  const isRouterProtectedByFirewall = (routerId) => isRouterProtectedBy(routerId, 'firewall');

Â  Â  const startDdosAnimation = (ddosId, routerId) => {
Â  Â  Â  Â  if (ddosIntervals[ddosId]) return;
Â  Â  Â  Â  const ddosDevice = devices[ddosId]?.element;
Â  Â  Â  Â  const routerDevice = devices[routerId]?.element;
Â  Â  Â  Â  if (!ddosDevice || !routerDevice) return;

Â  Â  Â  Â  ddosIntervals[ddosId] = setInterval(() => {
Â  Â  Â  Â  Â  Â  if (!devices[ddosId] || !devices[routerId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â stopDdosAnimation(ddosId);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const ddosRect = ddosDevice.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const routerRect = routerDevice.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const workspaceRect = workspace.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const startX = ddosRect.left + ddosRect.width / 2 - workspaceRect.left + (Math.random() - 0.5) * 40;
Â  Â  Â  Â  Â  Â  const startY = ddosRect.top + ddosRect.height / 2 - workspaceRect.top + (Math.random() - 0.5) * 40;
Â  Â  Â  Â  Â  Â  const endX = routerRect.left + routerRect.width / 2 - workspaceRect.left + (Math.random() - 0.5) * 50;
Â  Â  Â  Â  Â  Â  const endY = routerRect.top + routerRect.height / 2 - workspaceRect.top + (Math.random() - 0.5) * 50;
Â  Â  Â  Â  Â  Â  const packet = document.createElement('div');
Â  Â  Â  Â  Â  Â  packet.className = 'ddos-packet';
Â  Â  Â  Â  Â  Â  packet.style.left = `${startX}px`;
Â  Â  Â  Â  Â  Â  packet.style.top = `${startY}px`;
Â  Â  Â  Â  Â  Â  const translateX = endX - startX;
Â  Â  Â  Â  Â  Â  const translateY = endY - startY;
Â  Â  Â  Â  Â  Â  const distance = Math.sqrt(translateX*translateX + translateY*translateY);
Â  Â  Â  Â  Â  Â  const duration = distance / (300 + Math.random() * 100);
Â  Â  Â  Â  Â  Â  packet.style.setProperty('--tx', `${translateX}px`);
Â  Â  Â  Â  Â  Â  packet.style.setProperty('--ty', `${translateY}px`);
Â  Â  Â  Â  Â  Â  packet.style.animationDuration = `${Math.max(0.3, duration)}s`;
Â  Â  Â  Â  Â  Â  ddosPacketContainer.appendChild(packet);
Â  Â  Â  Â  Â  Â  packet.addEventListener('animationend', () => packet.remove());
Â  Â  Â  Â  }, 80);
Â  Â  };
Â  Â Â 
        // --- UPDATED FUNCTION ---
Â  Â  Â  Â  const updateDdosState = () => {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.cable-under-ddos, .device-ddos-victim, .under-ddos, .ddos-protected, .vpn-protected, .cable-scrubbing').forEach(el => {
Â  Â  Â  Â  Â  Â  Â  Â  el.classList.remove('cable-under-ddos', 'device-ddos-victim', 'under-ddos', 'ddos-protected', 'vpn-protected', 'cable-scrubbing');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const attackedRouterIds = new Set();
Â  Â  Â  Â  Â  Â  const scrubbedRouterIds = new Set();
Â  Â  Â  Â  Â  Â  const allTargetedRouterIds = new Set(); // To track all routers connected to a DDoS server

Â  Â  Â  Â  Â  Â  Object.values(devices).filter(d => d.type === 'ddos').forEach(ddosServer => {
Â  Â  Â  Â  Â  Â  Â  Â  const ddosId = ddosServer.element.id;
Â  Â  Â  Â  Â  Â  Â  Â  const connection = Object.values(cables).find(c => c.from === ddosId || c.to === ddosId);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  let isActivelyAttacking = false;

Â  Â  Â  Â  Â  Â  Â  Â  if (connection) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const neighborId = connection.from === ddosId ? connection.to : connection.from;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const neighbor = devices[neighborId];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (neighbor && (neighbor.type === 'router' || neighbor.type === 'router-v2')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allTargetedRouterIds.add(neighborId); // This router is being targeted

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isRouterScrubbed(neighborId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrubbedRouterIds.add(neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!ddosServer.isAttacking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`ğŸ›¡ï¸âœ¨ Há»‡ thá»‘ng Anti-DDoS Ä‘ang lá»c lÆ°u lÆ°á»£ng táº¥n cÃ´ng vÃ o ${neighbor.name}.`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startDdosAnimation(ddosId, neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isActivelyAttacking = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isRouterProtectedByFirewall(neighborId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ddosServer.isAttacking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`ğŸ›¡ï¸ Táº¥n cÃ´ng vÃ o ${neighbor.name} Ä‘Ã£ bá»‹ TÆ°á»ng lá»­a cháº·n!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isActivelyAttacking = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allTargetedRouterIds.delete(neighborId); // Firewall blocks it, so it's not a target for effects
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  attackedRouterIds.add(neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isActivelyAttacking = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!ddosServer.isAttacking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ddosServer.isAttacking = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.random() * 2000 + 2000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`ğŸ”¥ Server ${ddosServer.name} nháº¯m vÃ o ${neighbor.name}. Táº¥n cÃ´ng sau ${(delay / 1000).toFixed(1)}s...`, 'warn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ddosServer.attackTimeoutId) clearTimeout(ddosServer.attackTimeoutId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ddosServer.attackTimeoutId = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!devices[ddosId] || !devices[neighborId]) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`ğŸ”¥ Báº®T Äáº¦U Táº¤N CÃ”NG: ${ddosServer.name} -> ${neighbor.name}!`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, delay);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startDdosAnimation(ddosId, neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!isActivelyAttacking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ddosServer.isAttacking) addLog(`ğŸ›‘ Cuá»™c táº¥n cÃ´ng tá»« ${ddosServer.name} Ä‘Ã£ dá»«ng.`, 'warn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopDdosAnimation(ddosId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ddosServer.attackTimeoutId) clearTimeout(ddosServer.attackTimeoutId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ddosServer.attackTimeoutId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ddosServer.isAttacking = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ddosServer.isAttacking = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  attackedRouterIds.forEach(routerId => devices[routerId].element.classList.add('under-ddos'));
Â  Â  Â  Â  Â  Â  scrubbedRouterIds.forEach(routerId => devices[routerId].element.classList.add('ddos-protected'));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Object.values(devices).forEach(device => {
Â  Â  Â  Â  Â  Â  Â  Â  if (attackedRouterIds.has(device.connectedRouterId) && device.type !== 'router' && device.type !== 'router-v2' && device.type !== 'switch' && device.type !== 'ddos' && device.type !== 'firewall' && device.type !== 'anti-ddos-system') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (device.vpnEnabled) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â device.element.classList.add('vpn-protected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!device.element.dataset.notifiedProtected) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLog(`âœ… ${device.name} Ä‘Æ°á»£c báº£o vá»‡ bá»Ÿi VPN riÃªng.`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  device.element.dataset.notifiedProtected = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â device.element.classList.add('device-ddos-victim');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete device.element.dataset.notifiedProtected;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete device.element.dataset.notifiedProtected;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });


Â  Â  Â  Â  Â  Â  Object.values(cables).forEach(cable => {
Â  Â  Â  Â  Â  Â  Â  Â  const fromDevice = devices[cable.from];
Â  Â  Â  Â  Â  Â  Â  Â  const toDevice = devices[cable.to];
Â  Â  Â  Â  Â  Â  Â  Â  if(!fromDevice || !toDevice) return; // Failsafe for deleted devices

Â  Â  Â  Â  Â  Â  Â  Â  // Check for scrubbing link first (highest priority)
Â  Â  Â  Â  Â  Â  Â  Â  const isScrubbingLink = 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (fromDevice.type === 'anti-ddos-system' && allTargetedRouterIds.has(cable.to)) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (toDevice.type === 'anti-ddos-system' && allTargetedRouterIds.has(cable.from));

Â  Â  Â  Â  Â  Â  Â  Â  if (isScrubbingLink) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cable.element.classList.add('cable-scrubbing');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check for general affected cables
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isFromAffected = fromDevice.element.classList.contains('under-ddos') || fromDevice.element.classList.contains('device-ddos-victim');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isToAffected = toDevice.element.classList.contains('under-ddos') || toDevice.element.classList.contains('device-ddos-victim');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isFromAffected || isToAffected) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cable.element.classList.add('cable-under-ddos');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  const updateAllDeviceStates = () => {
Â  Â  Â  Â  Object.values(devices).forEach(d => {
Â  Â  Â  Â  Â  Â  d.publicIp = null;
Â  Â  Â  Â  Â  Â  d.connectedRouterId = null;
Â  Â  Â  Â  });
Â  Â  Â  Â  const allRouters = Object.values(devices).filter(dev => dev.type === 'router' || dev.type === 'router-v2');
Â  Â  Â  Â  allRouters.forEach(router => {
Â  Â  Â  Â  Â  Â  if (!router.publicIp) {
Â  Â  Â  Â  Â  Â  Â  Â  router.publicIp = `118.70.${Math.floor(Math.random() * 254) + 1}.${Math.floor(Math.random() * 254) + 1}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(router.element.querySelector('.public-ip-display')) {
Â  Â  Â  Â  Â  Â  Â  Â  router.element.querySelector('.public-ip-display').textContent = router.publicIp;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Use a proper pathfinding algorithm to assign public IP
Â  Â  Â  Â  Â  Â  const reachableDevices = findReachableDevices(router.element.id);
Â  Â  Â  Â  Â  Â  reachableDevices.forEach(devId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if(devices[devId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  devices[devId].publicIp = router.publicIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  devices[devId].connectedRouterId = router.element.id;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  Object.keys(devices).forEach(updateDeviceIpDisplayInWorkspace);
Â  Â  Â  Â Â 
Â  Â  Â  Â  checkForConflicts();
Â  Â  Â  Â  updateDdosState();
Â  Â  Â  Â  updateAllDeviceScreens();
Â  Â  Â  Â  updateCablePositions();
Â  Â  Â  Â  updateAllVlanVisuals();
Â  Â  };

Â  Â  const updateAllDeviceScreens = () => {
Â  Â  Â  Â  Object.keys(devices).forEach(id => {
Â  Â  Â  Â  Â  Â  const device = devices[id];
Â  Â  Â  Â  Â  Â  const screen = device.element.querySelector('.device-screen');
Â  Â  Â  Â  Â  Â  if (!screen) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Priority: Conflict/DDoS visuals override everything
Â  Â  Â  Â  Â  Â  if (device.element.classList.contains('ip-conflict')) {
Â  Â  Â  Â  Â  Â  Â  Â  screen.className = "device-screen screen-ip-conflict-visuals";
Â  Â  Â  Â  Â  Â  Â  Â  device.element.classList.add("has-connection");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (device.element.classList.contains('under-ddos') || device.element.classList.contains('device-ddos-victim')) {
Â  Â  Â  Â  Â  Â  Â  Â  device.element.classList.add('has-connection');
Â  Â  Â  Â  Â  Â  Â  Â  // The DDoS classes already handle the screen content
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clear previous state
Â  Â  Â  Â  Â  Â  device.element.classList.remove('has-connection');
Â  Â  Â  Â  Â  Â  screen.classList.remove('screen-internet', 'screen-lan-only', 'screen-internet-icon');

Â  Â  Â  Â  Â  Â  // Check VPN or Anti-DDoS protection
Â  Â  Â  Â  Â  Â  if (device.element.classList.contains('vpn-protected')) {
Â  Â  Â  Â  Â  Â  Â  Â  device.element.classList.add('has-connection');
Â  Â  Â  Â  Â  Â  Â  Â  screen.className = 'device-screen screen-internet';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (device.element.classList.contains('ddos-protected')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â device.element.classList.add('has-connection');
Â  Â  Â  Â  Â  Â  Â  Â  Â screen.classList.add('screen-internet-icon');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Regular connectivity check
Â  Â  Â  Â  Â  Â  const hasInternet = !!device.publicIp;
Â  Â  Â  Â  Â  Â  const isConnected = Object.values(cables).some(c => c.from === id || c.to === id);

Â  Â  Â  Â  Â  Â  if (hasInternet) {
Â  Â  Â  Â  Â  Â  Â  Â  device.element.classList.add('has-connection');
Â  Â  Â  Â  Â  Â  Â  Â  if (device.type === 'router' || device.type === 'router-v2' || device.type === 'switch') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.add('screen-internet-icon');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.add('screen-internet');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (isConnected) {
Â  Â  Â  Â  Â  Â  Â  Â  device.element.classList.add('has-connection');
Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.add('screen-lan-only');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  Â  const exportState = () => {
Â  Â  Â  Â  if (Object.keys(devices).length === 0) {
Â  Â  Â  Â  Â  Â  addLog("KhÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ xuáº¥t. HÃ£y thÃªm thiáº¿t bá»‹.", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const deviceData = Object.entries(devices).map(([id, dev]) => {
Â  Â  Â  Â  Â  Â  const data = {
Â  Â  Â  Â  Â  Â  Â  Â  id: id, name: dev.name, type: dev.type,
Â  Â  Â  Â  Â  Â  Â  Â  ipEnabled: dev.ipEnabled, vpnEnabled: dev.vpnEnabled, vpnIp: dev.vpnIp,
Â  Â  Â  Â  Â  Â  Â  Â  publicIp: (dev.type === "router" || dev.type === "router-v2") ? dev.publicIp : null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  privateIp: dev.privateIp,
Â  Â  Â  Â  Â  Â  Â  Â  left: dev.element.style.left, top: dev.element.style.top
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  if (dev.type === 'router-v2') {
Â  Â  Â  Â  Â  Â  Â  Â  data.vlans = dev.vlans;
Â  Â  Â  Â  Â  Â  Â  Â  data.vlanAssignments = dev.vlanAssignments;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  });
Â  Â  Â  Â  const cableData = Object.entries(cables).map(([id, cable]) => ({ id: id, from: cable.from, to: cable.to }));

Â  Â  Â  Â  const state = { idCounter, deviceCounters, cableCounter, devices: deviceData, cables: cableData };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const stateJson = JSON.stringify(state, null, 2);
Â  Â  Â  Â  const blob = new Blob([stateJson], { type: 'application/json' });
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  a.download = 'network-simulation.json';
Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  addLog("ÄÃ£ xuáº¥t tráº¡ng thÃ¡i máº¡ng ra file thÃ nh cÃ´ng!", "success");
Â  Â  };

Â  Â  const loadState = (state) => {
Â  Â  Â  Â  clearWorkspace();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  idCounter = state.idCounter || 0;Â 
Â  Â  Â  Â  Â  Â  cableCounter = state.cableCounter || 0;
Â  Â  Â  Â  Â  Â  deviceCounters = state.deviceCounters || {};

Â  Â  Â  Â  Â  Â  if (!state.deviceCounters && state.devices) {
Â  Â  Â  Â  Â  Â  Â  Â  addLog("Tá»‡p lÆ°u cÅ© Ä‘Æ°á»£c phÃ¡t hiá»‡n, Ä‘ang táº¡o láº¡i bá»™ Ä‘áº¿m...", "warn");
Â  Â  Â  Â  Â  Â  Â  Â  state.devices.forEach(device => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!deviceCounters[device.type]) deviceCounters[device.type] = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const match = device.name.match(/-(\d+)$/);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const num = parseInt(match[1], 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (num > deviceCounters[device.type]) deviceCounters[device.type] = num;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  state.devices.forEach(devData => {
Â  Â  Â  Â  Â  Â  Â  Â  const deviceElement = createDeviceElement(devData);
Â  Â  Â  Â  Â  Â  Â  Â  workspace.appendChild(deviceElement);
Â  Â  Â  Â  Â  Â  Â  Â  const devObject = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element: deviceElement, name: devData.name, type: devData.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ipEnabled: devData.ipEnabled, vpnEnabled: devData.vpnEnabled, vpnIp: devData.vpnIp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publicIp: devData.publicIp, privateIp: devData.privateIp, connectedRouterId: null
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  if (devData.type === 'router-v2') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  devObject.vlans = devData.vlans || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  devObject.vlanAssignments = devData.vlanAssignments || {};
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  devices[devData.id] = devObject;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  state.cables.forEach(cableData => {
Â  Â  Â  Â  Â  Â  Â  Â  createCable(cableData.from, cableData.to, cableData.id);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  Â  Â  Â  Â  addLog("ÄÃ£ táº£i tráº¡ng thÃ¡i máº¡ng tá»« file thÃ nh cÃ´ng!", "success");
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Lá»—i khi táº£i tráº¡ng thÃ¡i:", error);
Â  Â  Â  Â  Â  Â  addLog("File tráº¡ng thÃ¡i khÃ´ng há»£p lá»‡ hoáº·c bá»‹ lá»—i.", "error");
Â  Â  Â  Â  Â  Â  clearWorkspace();
Â  Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const handleManualIpChange = (e) => {
Â  Â  Â  Â  const deviceId = e.target.closest('.device').id;
Â  Â  Â  Â  const device = devices[deviceId];
Â  Â  Â  Â  if (!device) return;
Â  Â  Â  Â  const newIp = e.target.value.trim();
Â  Â  Â  Â  if (device.privateIp !== newIp) {
Â  Â  Â  Â  Â  Â  addLog(`ÄÃ£ cáº­p nháº­t IP cá»§a ${device.name} thÃ nh ${newIp || 'chÆ°a cÃ³'}.`, 'info');
Â  Â  Â  Â  Â  Â  device.privateIp = newIp || null;
Â  Â  Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  Â  Â  }
Â  Â  };

Â  Â  const createCable = (fromId, toId, providedId = null) => {
Â  Â  Â  Â  if (!devices[fromId] || !devices[toId]) return;
Â  Â  Â  Â  if (Object.values(cables).some(c => (c.from === fromId && c.to === toId) || (c.from === toId && c.to === fromId))) {
Â  Â  Â  Â  Â  Â  addLog(`Káº¿t ná»‘i giá»¯a ${devices[fromId].name} vÃ  ${devices[toId].name} Ä‘Ã£ tá»“n táº¡i!`, 'warn');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const cableId = providedId || `cable-${++cableCounter}`;
Â  Â  Â  Â  if (!providedId) cableCounter++;

Â  Â  Â  Â  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
Â  Â  Â  Â  line.id = cableId;
Â  Â  Â  Â  line.setAttribute('stroke', 'var(--cable-color)');
Â  Â  Â  Â  line.setAttribute('stroke-width', '4');
Â  Â  Â  Â  line.addEventListener('contextmenu', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  showCableContextMenu(e.clientX, e.clientY, cableId);
Â  Â  Â  Â  });
Â  Â  Â  Â  cableSvg.appendChild(line);
Â  Â  Â  Â  cables[cableId] = { id: cableId, from: fromId, to: toId, element: line };
Â  Â  Â  Â  addLog(`ÄÃ£ ná»‘i ${devices[fromId].name} vÃ  ${devices[toId].name}.`, 'success');
Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  };

Â  Â  const removeCable = (cableId, update = true) => {
Â  Â  Â  Â  const cable = cables[cableId];
Â  Â  Â  Â  if (cable) {
Â  Â  Â  Â  Â  Â  const fromName = devices[cable.from]?.name || 'thiáº¿t bá»‹ Ä‘Ã£ xÃ³a';
Â  Â  Â  Â  Â  Â  const toName = devices[cable.to]?.name || 'thiáº¿t bá»‹ Ä‘Ã£ xÃ³a';
Â  Â  Â  Â  Â  Â  addLog(`ÄÃ£ xÃ³a káº¿t ná»‘i giá»¯a ${fromName} vÃ  ${toName}.`, 'warn');

Â  Â  Â  Â  Â  Â  // Clean up VLAN assignment
Â  Â  Â  Â  Â  Â  Object.values(devices).filter(d => d.type === 'router-v2').forEach(router => {
Â  Â  Â  Â  Â  Â  Â  Â  if(router.vlanAssignments && router.vlanAssignments[cableId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete router.vlanAssignments[cableId];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (cable.element.parentNode) {
Â  Â  Â  Â  Â  Â  Â  Â  cableSvg.removeChild(cable.element);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  delete cables[cableId];
Â  Â  Â  Â  Â  Â  if (update) {
Â  Â  Â  Â  Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  };

Â  Â  const updateCablePositions = () => {
Â  Â  Â  Â  Object.values(cables).forEach(cable => {
Â  Â  Â  Â  Â  Â  const fromEl = devices[cable.from]?.element;
Â  Â  Â  Â  Â  Â  const toEl = devices[cable.to]?.element;
Â  Â  Â  Â  Â  Â  if (fromEl && toEl) {
Â  Â  Â  Â  Â  Â  Â  Â  const fromRect = fromEl.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  const toRect = toEl.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  const workspaceRect = workspace.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  const x1 = fromRect.left + fromRect.width / 2 - workspaceRect.left;
Â  Â  Â  Â  Â  Â  Â  Â  const y1 = fromRect.top + fromRect.height / 2 - workspaceRect.top;
Â  Â  Â  Â  Â  Â  Â  Â  const x2 = toRect.left + toRect.width / 2 - workspaceRect.left;
Â  Â  Â  Â  Â  Â  Â  Â  const y2 = toRect.top + toRect.height / 2 - workspaceRect.top;
Â  Â  Â  Â  Â  Â  Â  Â  cable.element.setAttribute('x1', x1);
Â  Â  Â  Â  Â  Â  Â  Â  cable.element.setAttribute('y1', y1);
Â  Â  Â  Â  Â  Â  Â  Â  cable.element.setAttribute('x2', x2);
Â  Â  Â  Â  Â  Â  Â  Â  cable.element.setAttribute('y2', y2);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  Â  const updateDeviceIpDisplayInWorkspace = (deviceId) => {
Â  Â  Â  Â  const device = devices[deviceId];
Â  Â  Â  Â  if (!device || !device.ipEnabled) return;
Â  Â  Â  Â  const publicIpEl = device.element.querySelector('.public-ip-on-device');
Â  Â  Â  Â  if (!publicIpEl) return;

Â  Â  Â  Â  if (device.vpnEnabled) {
Â  Â  Â  Â  Â  Â  if (!device.vpnIp) {
Â  Â  Â  Â  Â  Â  Â  Â  device.vpnIp = `45.8.${Math.floor(Math.random() * 254) + 1}.${Math.floor(Math.random() * 254) + 1}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  publicIpEl.textContent = device.vpnIp;
Â  Â  Â  Â  Â  Â  publicIpEl.style.color = 'var(--green-success)';
Â  Â  Â  Â  Â  Â  publicIpEl.title = 'IP VPN (Chá»‘ng DDoS)';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  publicIpEl.textContent = device.publicIp || 'ChÆ°a káº¿t ná»‘i';
Â  Â  Â  Â  Â  Â  publicIpEl.style.color = 'var(--secondary-yellow)';
Â  Â  Â  Â  Â  Â  publicIpEl.title = 'IP Public (tá»« Router)';
Â  Â  Â  Â  }
Â  Â  };

Â  Â  const findReachableDevices = (startNodeId) => {
Â  Â  Â  Â  const visited = new Set();
Â  Â  Â  Â  const queue = [startNodeId];
Â  Â  Â  Â  visited.add(startNodeId);
Â  Â  Â  Â  while (queue.length > 0) {
Â  Â  Â  Â  Â  Â  const currentId = queue.shift();
Â  Â  Â  Â  Â  Â  Object.values(cables).forEach(cable => {
Â  Â  Â  Â  Â  Â  Â  Â  let neighborId = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (cable.from === currentId) neighborId = cable.to;
Â  Â  Â  Â  Â  Â  Â  Â  else if (cable.to === currentId) neighborId = cable.from;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (neighborId && !visited.has(neighborId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visited.add(neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  queue.push(neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  return visited;
Â  Â  };

Â  Â  const findPath = (startId, endId) => {
Â  Â  Â  Â  const queue = [{ id: startId, path: [startId], lastCableId: null }];
Â  Â  Â  Â  const visited = new Set([startId]);

Â  Â  Â  Â  while (queue.length > 0) {
Â  Â  Â  Â  Â  Â  const { id: currentId, path, lastCableId } = queue.shift();

Â  Â  Â  Â  Â  Â  if (currentId === endId) {
Â  Â  Â  Â  Â  Â  Â  Â  return path;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Object.entries(cables).forEach(([cableId, cable]) => {
Â  Â  Â  Â  Â  Â  Â  Â  let neighborId = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (cable.from === currentId) neighborId = cable.to;
Â  Â  Â  Â  Â  Â  Â  Â  else if (cable.to === currentId) neighborId = cable.from;

Â  Â  Â  Â  Â  Â  Â  Â  if (neighborId && !visited.has(neighborId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentNode = devices[currentId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // VLAN Check at Router V2
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentNode?.type === 'router-v2') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const vlanIn = currentNode.vlanAssignments[lastCableId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const vlanOut = currentNode.vlanAssignments[cableId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (vlanIn !== vlanOut) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Block path if VLANs don't match
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visited.add(neighborId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  queue.push({ id: neighborId, path: [...path, neighborId], lastCableId: cableId });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  return null; // No path found
Â  Â  };

Â  Â  const checkForConflicts = () => {
Â  Â  Â  Â  const ipMap = {};
Â  Â  Â  Â  Object.values(devices).forEach(dev => {
Â  Â  Â  Â  Â  Â  dev.element.classList.remove('ip-conflict');
Â  Â  Â  Â  });

Â  Â  Â  Â  Object.entries(devices).forEach(([id, device]) => {
Â  Â  Â  Â  Â  Â  if (device.privateIp) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!ipMap[device.privateIp]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ipMap[device.privateIp] = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  ipMap[device.privateIp].push(id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  Object.values(ipMap).forEach(ids => {
Â  Â  Â  Â  Â  Â  if (ids.length > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  const conflictIp = devices[ids[0]].privateIp;
Â  Â  Â  Â  Â  Â  Â  Â  addLog(`PhÃ¡t hiá»‡n trÃ¹ng IP: ${conflictIp}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  ids.forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const device = devices[id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (device) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  device.element.classList.add('ip-conflict');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  Â  const runDhcp = () => {
Â  Â  Â  Â  addLog("Báº¯t Ä‘áº§u tiáº¿n trÃ¬nh cáº¥p IP (DHCP)...", "warn");
Â  Â  Â  Â  const routers = Object.entries(devices).filter(([, dev]) => dev.type === 'router' || dev.type === 'router-v2');
Â  Â  Â  Â  let regularRouterCounter = 0;

Â  Â  Â  Â  routers.forEach(([routerId, router]) => {
Â  Â  Â  Â  Â  Â  if (router.type === 'router') {
Â  Â  Â  Â  Â  Â  Â  Â  regularRouterCounter++;
Â  Â  Â  Â  Â  Â  Â  Â  let subnet = `192.168.${regularRouterCounter}.`;
Â  Â  Â  Â  Â  Â  Â  Â  let lastOctet = 10;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const connectedDevices = findReachableDevices(routerId);
Â  Â  Â  Â  Â  Â  Â  Â  connectedDevices.forEach(devId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const device = devices[devId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (device && device.ipEnabled && !device.privateIp) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let newIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â do {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newIp = subnet + lastOctet++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } while (Object.values(devices).some(d => d.privateIp === newIp));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â device.privateIp = newIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const ipInput = device.element.querySelector('.ip-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (ipInput) ipInput.value = device.privateIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â addLog(`ÄÃ£ cáº¥p IP ${device.privateIp} cho ${device.name}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else if (router.type === 'router-v2') {
Â  Â  Â  Â  Â  Â  Â  Â  // DHCP for each configured VLAN
Â  Â  Â  Â  Â  Â  Â  Â  router.vlans.forEach(vlan => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let subnet = `192.168.${vlan.id}.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let lastOctet = 10;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const devicesInVlan = Object.entries(cables)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(([, c]) => (c.from === routerId || c.to === routerId) && router.vlanAssignments[c.id] === vlan.id)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(([, c]) => devices[c.from === routerId ? c.to : c.from]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  devicesInVlan.forEach(device => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (device && device.ipEnabled && !device.privateIp) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let newIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â do {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newIp = subnet + lastOctet++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } while (Object.values(devices).some(d => d.privateIp === newIp));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â device.privateIp = newIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const ipInput = device.element.querySelector('.ip-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (ipInput) ipInput.value = device.privateIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â addLog(`ÄÃ£ cáº¥p IP ${device.privateIp} cho ${device.name} (VLAN ${vlan.id})`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // DHCP for untagged devices
Â  Â  Â  Â  Â  Â  Â  Â  let untaggedSubnet = `192.168.254.`;
Â  Â  Â  Â  Â  Â  Â  Â  let untaggedLastOctet = 10;
Â  Â  Â  Â  Â  Â  Â  Â  const untaggedDevices = Object.entries(cables)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(([, c]) => (c.from === routerId || c.to === routerId) && !router.vlanAssignments[c.id])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(([, c]) => devices[c.from === routerId ? c.to : c.from]);

Â  Â  Â  Â  Â  Â  Â  Â  untaggedDevices.forEach(device => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (device && device.ipEnabled && !device.privateIp) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let newIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â do {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newIp = untaggedSubnet + untaggedLastOctet++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } while (Object.values(devices).some(d => d.privateIp === newIp));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â device.privateIp = newIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const ipInput = device.element.querySelector('.ip-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (ipInput) ipInput.value = device.privateIp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â addLog(`ÄÃ£ cáº¥p IP ${device.privateIp} cho ${device.name} (VLAN Máº·c Ä‘á»‹nh)`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  Â  Â  addLog("HoÃ n táº¥t cáº¥p IP.", "success");
Â  Â  };

Â  Â  // --- Event Handlers ---
Â  Â  function onDeviceDoubleClick(e) {
Â  Â  Â  Â  const deviceId = e.currentTarget.id;
Â  Â  Â  Â  const device = devices[deviceId];
Â  Â  Â  Â  if (device.type === 'pc' || device.type === 'phone') {
Â  Â  Â  Â  Â  Â  showDeviceInfoModal(deviceId);
Â  Â  Â  Â  } else if (device.type === 'router-v2') {
Â  Â  Â  Â  Â  Â  showVlanModal(deviceId);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function onDeviceClick(e) {
Â  Â  Â  Â  if (pingInProgress || e.target.closest('.ip-input, .connect-btn')) return;
Â  Â  Â  Â  const deviceId = e.currentTarget.id;
Â  Â  Â  Â  if (isPingMode && pingSourceDevice && pingSourceDevice !== deviceId) {
Â  Â  Â  Â  Â  Â  executePing(pingSourceDevice, deviceId);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function onMouseDown(e) {
Â  Â  Â  Â  if (isConnecting || pingInProgress || e.target.closest('.ip-input, .remove-btn, .ping-btn, .connect-btn')) return;
Â  Â  Â  Â  draggedDevice = e.currentTarget;
Â  Â  Â  Â  draggedDevice.style.cursor = 'grabbing';
Â  Â  Â  Â  draggedDevice.style.zIndex = 1000;
Â  Â  Â  Â  const rect = draggedDevice.getBoundingClientRect();
Â  Â  Â  Â  offsetX = e.clientX - rect.left;
Â  Â  Â  Â  offsetY = e.clientY - rect.top;
Â  Â  Â  Â  document.addEventListener('mousemove', onMouseMove);
Â  Â  Â  Â  document.addEventListener('mouseup', onMouseUp);
Â  Â  }

Â  Â  function onConnectStart(e) {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  isConnecting = true;
Â  Â  Â  Â  connectionSourceId = e.target.closest('.device').id;
Â  Â  Â  Â  const sourceEl = devices[connectionSourceId].element;
Â  Â  Â  Â  const workspaceRect = workspace.getBoundingClientRect();
Â  Â  Â  Â  const sourceRect = sourceEl.getBoundingClientRect();
Â  Â  Â  Â  const startX = sourceRect.left + sourceRect.width / 2 - workspaceRect.left;
Â  Â  Â  Â  const startY = sourceRect.top + sourceRect.height / 2 - workspaceRect.top;
Â  Â  Â  Â  tempCableLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
Â  Â  Â  Â  tempCableLine.setAttribute('stroke', 'var(--secondary-yellow)');
Â  Â  Â  Â  tempCableLine.setAttribute('stroke-width', '4');
Â  Â  Â  Â  tempCableLine.setAttribute('stroke-dasharray', '5 5');
Â  Â  Â  Â  tempCableLine.setAttribute('x1', startX);
Â  Â  Â  Â  tempCableLine.setAttribute('y1', startY);
Â  Â  Â  Â  tempCableLine.setAttribute('x2', startX);
Â  Â  Â  Â  tempCableLine.setAttribute('y2', startY);
Â  Â  Â  Â  cableSvg.appendChild(tempCableLine);
Â  Â  Â  Â  document.addEventListener('mousemove', onConnectMove);
Â  Â  Â  Â  document.addEventListener('mouseup', onConnectEnd, { once: true });
Â  Â  }

Â  Â  function onConnectMove(e) {
Â  Â  Â  Â  if (!isConnecting || !tempCableLine) return;
Â  Â  Â  Â  const workspaceRect = workspace.getBoundingClientRect();
Â  Â  Â  Â  const endX = e.clientX - workspaceRect.left;
Â  Â  Â  Â  const endY = e.clientY - workspaceRect.top;
Â  Â  Â  Â  tempCableLine.setAttribute('x2', endX);
Â  Â  Â  Â  tempCableLine.setAttribute('y2', endY);
Â  Â  }

Â  Â  function onConnectEnd(e) {
Â  Â  Â  Â  if (tempCableLine) {
Â  Â  Â  Â  Â  Â  tempCableLine.remove();
Â  Â  Â  Â  Â  Â  tempCableLine = null;
Â  Â  Â  Â  }
Â  Â  Â  Â  const targetEl = document.elementFromPoint(e.clientX, e.clientY)?.closest('.device');
Â  Â  Â  Â  if (targetEl && devices[targetEl.id] && targetEl.id !== connectionSourceId) {
Â  Â  Â  Â  Â  Â  createCable(connectionSourceId, targetEl.id);
Â  Â  Â  Â  }
Â  Â  Â  Â  isConnecting = false;
Â  Â  Â  Â  connectionSourceId = null;
Â  Â  Â  Â  document.removeEventListener('mousemove', onConnectMove);
Â  Â  }

Â  Â  function onMouseMove(e) {
Â  Â  Â  Â  if (!draggedDevice) return;
Â  Â  Â  Â  const workspaceRect = workspace.getBoundingClientRect();
Â  Â  Â  Â  let newLeft = e.clientX - offsetX - workspaceRect.left;
Â  Â  Â  Â  let newTop = e.clientY - offsetY - workspaceRect.top;
Â  Â  Â  Â  newLeft = Math.max(0, Math.min(newLeft, workspace.clientWidth - draggedDevice.offsetWidth));
Â  Â  Â  Â  newTop = Math.max(0, Math.min(newTop, workspace.clientHeight - draggedDevice.offsetHeight));
Â  Â  Â  Â  draggedDevice.style.left = `${newLeft}px`;
Â  Â  Â  Â  draggedDevice.style.top = `${newTop}px`;
Â  Â  Â  Â  updateCablePositions();
Â  Â  }

Â  Â  function onMouseUp() {
Â  Â  Â  Â  if (draggedDevice) {
Â  Â  Â  Â  Â  Â  draggedDevice.style.cursor = 'grab';
Â  Â  Â  Â  Â  Â  draggedDevice.style.zIndex = 'auto';
Â  Â  Â  Â  }
Â  Â  Â  Â  draggedDevice = null;
Â  Â  Â  Â  document.removeEventListener('mousemove', onMouseMove);
Â  Â  Â  Â  document.removeEventListener('mouseup', onMouseUp);
Â  Â  }

Â  Â  const startPing = (deviceId) => {
Â  Â  Â  Â  if (isConnecting || pingInProgress) {
Â  Â  Â  Â  Â  Â  addLog('KhÃ´ng thá»ƒ Ping khi Ä‘ang thá»±c hiá»‡n hÃ nh Ä‘á»™ng khÃ¡c.', 'error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  isPingMode = true;
Â  Â  Â  Â  pingSourceDevice = deviceId;
Â  Â  Â  Â  Object.values(devices).forEach(d => d.element.classList.remove('ping-source'));
Â  Â  Â  Â  devices[deviceId].element.classList.add('ping-source');
Â  Â  Â  Â  workspace.style.cursor = 'crosshair';
Â  Â  Â  Â  addLog(`Cháº¿ Ä‘á»™ Ping: Tá»« ${devices[deviceId].name}. Chá»n thiáº¿t bá»‹ Ä‘Ã­ch.`, 'warn');
Â  Â  };

Â  Â  const cancelPingSelection = () => {
Â  Â  Â  Â  isPingMode = false;
Â  Â  Â  Â  if (pingSourceDevice && devices[pingSourceDevice]) {
Â  Â  Â  Â  Â  Â  devices[pingSourceDevice].element.classList.remove('ping-source');
Â  Â  Â  Â  }
Â  Â  Â  Â  pingSourceDevice = null;
Â  Â  Â  Â  workspace.style.cursor = 'default';
Â  Â  Â  Â  addLog('ÄÃ£ há»§y cháº¿ Ä‘á»™ chá»n Ping.', 'info');
Â  Â  };

Â  Â  const endPingProcess = () => {
Â  Â  Â  Â  if (!pingInProgress) return;
Â  Â  Â  Â  if (pingTimeoutId) clearTimeout(pingTimeoutId);
Â  Â  Â  Â  pingTimeoutId = null;
Â  Â  Â  Â  pingInProgress = false;
Â  Â  Â  Â  workspace.classList.remove('ping-isolation-mode');
Â  Â  Â  Â  cableSvg.classList.remove('ping-isolation-mode');
Â  Â  Â  Â  document.querySelectorAll('.ping-active').forEach(el => el.classList.remove('ping-active'));
Â  Â  Â  Â  pingOverlay.style.display = 'none';
Â  Â  Â  Â  pingLogDisplay.innerHTML = '';
Â  Â  Â  Â  addLog('Tiáº¿n trÃ¬nh Ping Ä‘Ã£ káº¿t thÃºc.', 'info');
Â  Â  };

Â  Â  const animatePingPackets = (path, durationPerHop = 1000) => {
Â  Â  Â  Â  for (let i = 0; i < path.length - 1; i++) {
Â  Â  Â  Â  Â  Â  const fromId = path[i];
Â  Â  Â  Â  Â  Â  const toId = path[i+1];
Â  Â  Â  Â  Â  Â  const cable = Object.values(cables).find(c => (c.from === fromId && c.to === toId) || (c.from === toId && c.to === fromId));
Â  Â  Â  Â  Â  Â  if (cable) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!pingInProgress) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pingLine = cable.element.cloneNode();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pingLine.removeAttribute('id');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pingLine.classList.add('cable-ping');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pingLine.style.animationDuration = `${durationPerHop / 1000}s`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cableSvg.appendChild(pingLine);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pingLine.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pingLine.parentNode === cableSvg) cableSvg.removeChild(pingLine);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const x1 = cable.element.getAttribute('x1');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y1 = cable.element.getAttribute('y1');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const x2 = cable.element.getAttribute('x2');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y2 = cable.element.getAttribute('y2');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textEl.textContent = 'ping';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textEl.classList.add('ping-packet-text');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motion.setAttribute('dur', `${durationPerHop/1000}s`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motion.setAttribute('fill', 'freeze');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motion.setAttribute('path', `M${x1},${y1} L${x2},${y2}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textEl.appendChild(motion);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cableSvg.appendChild(textEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (textEl.parentNode === cableSvg) cableSvg.removeChild(textEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, durationPerHop);

Â  Â  Â  Â  Â  Â  Â  Â  }, i * durationPerHop);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const executePing = (sourceId, targetId) => {
Â  Â  Â  Â  const sourceDevice = devices[sourceId];
Â  Â  Â  Â  const targetDevice = devices[targetId];
Â  Â  Â  Â  const targetName = targetDevice.privateIp || targetDevice.name;
Â  Â  Â  Â  cancelPingSelection();
Â  Â  Â  Â  addLog(`Báº¯t Ä‘áº§u ping tá»« ${sourceDevice.name} Ä‘áº¿n ${targetDevice.name}...`, 'info');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const path = findPath(sourceId, targetId);
Â  Â  Â  Â  pingInProgress = true;
Â  Â  Â  Â  workspace.classList.add('ping-isolation-mode');
Â  Â  Â  Â  cableSvg.classList.add('ping-isolation-mode');
Â  Â  Â  Â  pingOverlay.style.display = 'flex';
Â  Â  Â  Â  pingLogDisplay.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const logPing = (message, color = 'white') => {
Â  Â  Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  Â  Â  p.textContent = message;
Â  Â  Â  Â  Â  Â  p.style.color = color;
Â  Â  Â  Â  Â  Â  pingLogDisplay.appendChild(p);
Â  Â  Â  Â  Â  Â  pingLogDisplay.scrollTop = pingLogDisplay.scrollHeight;
Â  Â  Â  Â  };

Â  Â  Â  Â  if (path) {
Â  Â  Â  Â  Â  Â  path.forEach(id => devices[id].element.classList.add('ping-active'));
Â  Â  Â  Â  Â  Â  for (let i = 0; i < path.length - 1; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const cable = Object.values(cables).find(c => (c.from === path[i] && c.to === path[i+1]) || (c.from === path[i+1] && c.to === path[i]));
Â  Â  Â  Â  Â  Â  Â  Â  if (cable) cable.element.classList.add('ping-active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  logPing(`Pinging ${targetDevice.name} [${targetName}] with 32 bytes of data:`);
Â  Â  Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  Â  Â  const interval = 1500;
Â  Â  Â  Â  Â  Â  const sendReply = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!pingInProgress) return;
Â  Â  Â  Â  Â  Â  Â  Â  if (count >= 4) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logPing(`\nPing statistics for ${targetName}:`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logPing(`Â  Â  Packets: Sent = 4, Received = 4, Lost = 0 (0% loss)`, 'var(--secondary-yellow)');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pingTimeoutId = setTimeout(endPingProcess, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const latency = (path.length - 1) * 2 + Math.floor(Math.random() * 10);
Â  Â  Â  Â  Â  Â  Â  Â  logPing(`Reply from ${targetName}: bytes=32 time=${latency}ms TTL=128`, 'var(--green-success)');
Â  Â  Â  Â  Â  Â  Â  Â  animatePingPackets(path, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  Â  Â  Â  Â  pingTimeoutId = setTimeout(sendReply, interval);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  sendReply();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sourceDevice.element.classList.add('ping-active');
Â  Â  Â  Â  Â  Â  targetDevice.element.classList.add('ping-active');
Â  Â  Â  Â  Â  Â  logPing(`Pinging ${targetDevice.name} [${targetName}]...`);
Â  Â  Â  Â  Â  Â  logPing('Request timed out.', 'var(--red-error)');
Â  Â  Â  Â  Â  Â  pingTimeoutId = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!pingInProgress) return;
Â  Â  Â  Â  Â  Â  Â  Â  logPing('Request timed out.', 'var(--red-error)');
Â  Â  Â  Â  Â  Â  Â  Â  logPing(`\nPing statistics for ${targetName}:`);
Â  Â  Â  Â  Â  Â  Â  Â  logPing(`Â  Â  Packets: Sent = 2, Received = 0, Lost = 2 (100% loss)`, 'var(--secondary-yellow)');
Â  Â  Â  Â  Â  Â  Â  Â  pingTimeoutId = setTimeout(endPingProcess, 3000);
Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  // --- Modal Functions ---
Â  Â  const showConnectionModal = (newDeviceId, newDeviceName) => {
Â  Â  Â  Â  modalTitle.textContent = `Káº¿t ná»‘i ${newDeviceName} vá»›i cÃ¡c thiáº¿t bá»‹`;
Â  Â  Â  Â  connectionModal.dataset.newDeviceId = newDeviceId;
Â  Â  Â  Â  deviceFilterButtons.querySelector('button.active')?.classList.remove('active');
Â  Â  Â  Â  deviceFilterButtons.querySelector('button[data-filter="all"]').classList.add('active');
Â  Â  Â  Â  populateDeviceList('all');
Â  Â  Â  Â  connectionModal.style.display = 'flex';
Â  Â  };
Â  Â  const hideConnectionModal = () => { connectionModal.style.display = 'none'; };

Â  Â  const isAlreadyConnectedToSwitchOrRouter = (deviceId) => {
Â  Â  Â  Â  Â return Object.values(cables).some(c => {
Â  Â  Â  Â  Â  Â  let neighborId = null;
Â  Â  Â  Â  Â  Â  if (c.from === deviceId) neighborId = c.to;
Â  Â  Â  Â  Â  Â  else if (c.to === deviceId) neighborId = c.from;
Â  Â  Â  Â  Â  Â  else return false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return neighborId && devices[neighborId] && ['switch', 'router', 'router-v2'].includes(devices[neighborId].type);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  const populateDeviceList = (filter) => {
Â  Â  Â  Â  deviceSelectionList.innerHTML = '';
Â  Â  Â  Â  const availableDevices = Object.entries(devices)
Â  Â  Â  Â  Â  Â  .filter(([id, dev]) => (dev.type === 'pc' || dev.type === 'phone') && !isAlreadyConnectedToSwitchOrRouter(id))
Â  Â  Â  Â  Â  Â  .filter(([, dev]) => filter === 'all' || dev.type === filter);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (availableDevices.length === 0) {
Â  Â  Â  Â  Â  Â  deviceSelectionList.innerHTML = '<p style="text-align:center; width:100%; padding: 20px 0;">KhÃ´ng cÃ³ thiáº¿t bá»‹ nÃ o phÃ¹ há»£p.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  availableDevices.forEach(([id, dev]) => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'device-list-item';
Â  Â  Â  Â  Â  Â  item.textContent = `${dev.name} ${dev.type === 'pc' ? 'ğŸ’»' : 'ğŸ“±'}`;
Â  Â  Â  Â  Â  Â  item.dataset.deviceId = id;
Â  Â  Â  Â  Â  Â  item.addEventListener('click', () => item.classList.toggle('selected'));
Â  Â  Â  Â  Â  Â  deviceSelectionList.appendChild(item);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  const showDeviceInfoModal = (deviceId) => {
Â  Â  Â  Â  const device = devices[deviceId];
Â  Â  Â  Â  if (device) {
Â  Â  Â  Â  Â  Â  deviceInfoModal.dataset.currentDeviceId = deviceId;
Â  Â  Â  Â  Â  Â  infoModalTitle.textContent = `ThÃ´ng tin ${device.name}`;
Â  Â  Â  Â  Â  Â  infoDeviceName.textContent = device.name;
Â  Â  Â  Â  Â  Â  infoPrivateIp.textContent = device.privateIp || 'ChÆ°a Ä‘Æ°á»£c cáº¥p';
Â  Â  Â  Â  Â  Â  vpnToggle.checked = device.vpnEnabled;
Â  Â  Â  Â  Â  Â  updateVpnDisplay(deviceId);
Â  Â  Â  Â  Â  Â  deviceInfoModal.style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  };
Â  Â  const hideDeviceInfoModal = () => { deviceInfoModal.style.display = 'none'; };

Â  Â  const updateVpnDisplay = (deviceId) => {
Â  Â  Â  Â  const device = devices[deviceId];
Â  Â  Â  Â  if (!device) return;
Â  Â  Â  Â  const vpnLabel = deviceInfoModal.querySelector('.vpn-info-label');
Â  Â  Â  Â  const vpnIpDisplay = deviceInfoModal.querySelector('#info-vpn-ip');

Â  Â  Â  Â  infoPublicIp.textContent = device.publicIp || 'KhÃ´ng cÃ³ Internet';
Â  Â  Â  Â  infoPublicIp.style.color = device.publicIp ? 'var(--secondary-yellow)' : 'var(--red-error)';

Â  Â  Â  Â  if (device.vpnEnabled) {
Â  Â  Â  Â  Â  Â  if(!device.vpnIp) device.vpnIp = `45.8.${Math.floor(Math.random() * 254) + 1}.${Math.floor(Math.random() * 254) + 1}`;
Â  Â  Â  Â  Â  Â  vpnIpDisplay.textContent = device.vpnIp;
Â  Â  Â  Â  Â  Â  vpnIpDisplay.style.color = 'var(--green-success)';
Â  Â  Â  Â  Â  Â  vpnLabel.style.display = '';
Â  Â  Â  Â  Â  Â  vpnIpDisplay.style.display = '';
Â  Â  Â  Â  Â  Â  vpnStatus.textContent = 'Äang Báº¬T';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  vpnLabel.style.display = 'none';
Â  Â  Â  Â  Â  Â  vpnIpDisplay.style.display = 'none';
Â  Â  Â  Â  Â  Â  vpnStatus.textContent = 'Äang Táº®T';
Â  Â  Â  Â  }
Â  Â  };

Â  Â  const showCableContextMenu = (x, y, cableId) => {
Â  Â  Â  Â  removeCableContextMenu();
Â  Â  Â  Â  const menu = document.createElement('div');
Â  Â  Â  Â  menu.id = 'cable-context-menu';
Â  Â  Â  Â  menu.style.left = `${x}px`;
Â  Â  Â  Â  menu.style.top = `${y}px`;
Â  Â  Â  Â  menu.innerHTML = `<button>XÃ³a káº¿t ná»‘i</button>`;
Â  Â  Â  Â  document.body.appendChild(menu);
Â  Â  Â  Â  menu.querySelector('button').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  removeCable(cableId);
Â  Â  Â  Â  Â  Â  removeCableContextMenu();
Â  Â  Â  Â  });
Â  Â  };
Â  Â  const removeCableContextMenu = () => { document.getElementById('cable-context-menu')?.remove(); };

Â  Â  const showVlanModal = (routerId) => {
Â  Â  Â  Â  const router = devices[routerId];
Â  Â  Â  Â  if (!router || router.type !== 'router-v2') return;

Â  Â  Â  Â  vlanModal.dataset.currentRouterId = routerId;
Â  Â  Â  Â  vlanModalTitle.textContent = `Quáº£n lÃ½ VLAN cho ${router.name}`;
Â  Â  Â  Â  vlanModal.dataset.tempVlans = JSON.stringify(router.vlans);
Â  Â  Â  Â  populateVlanPortAssignments(routerId);
Â  Â  Â  Â  vlanModal.style.display = 'flex';
Â  Â  };
Â  Â  const hideVlanModal = () => {
Â  Â  Â  Â  vlanModal.style.display = 'none';
Â  Â  Â  Â  vlanIdInput.value = '';
Â  Â  Â  Â  vlanNameInput.value = '';
Â  Â  };

Â  Â  const populateVlanPortAssignments = (routerId) => {
Â  Â  Â  Â  const router = devices[routerId];
Â  Â  Â  Â  const tempVlans = JSON.parse(vlanModal.dataset.tempVlans);
Â  Â  Â  Â  vlanPortAssignments.innerHTML = '';

Â  Â  Â  Â  const connectedCables = Object.values(cables).filter(c => c.from === routerId || c.to === routerId);

Â  Â  Â  Â  if (connectedCables.length === 0) {
Â  Â  Â  Â  Â  Â  vlanPortAssignments.innerHTML = '<p style="text-align: center; padding: 10px 0;">KhÃ´ng cÃ³ thiáº¿t bá»‹ nÃ o Ä‘Æ°á»£c káº¿t ná»‘i.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  connectedCables.forEach(cable => {
Â  Â  Â  Â  Â  Â  const neighborId = cable.from === routerId ? cable.to : cable.from;
Â  Â  Â  Â  Â  Â  const neighborDevice = devices[neighborId];
Â  Â  Â  Â  Â  Â  if (!neighborDevice) return;

Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'vlan-port-item';
Â  Â  Â  Â  Â  Â  item.dataset.cableId = cable.id;

Â  Â  Â  Â  Â  Â  const nameSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  nameSpan.textContent = `Cá»•ng tá»›i ${neighborDevice.name}`;

Â  Â  Â  Â  Â  Â  const select = document.createElement('select');
Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Máº·c Ä‘á»‹nh (Untagged)</option>';
Â  Â  Â  Â  Â  Â  tempVlans.forEach(vlan => {
Â  Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  option.value = vlan.id;
Â  Â  Â  Â  Â  Â  Â  Â  option.textContent = `VLAN ${vlan.id}: ${vlan.name}`;
Â  Â  Â  Â  Â  Â  Â  Â  option.style.color = `var(${vlanColors[vlan.id % vlanColors.length]})`;
Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(option);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const currentVlanId = router.vlanAssignments[cable.id];
Â  Â  Â  Â  Â  Â  if (currentVlanId) {
Â  Â  Â  Â  Â  Â  Â  Â  select.value = currentVlanId;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  item.appendChild(nameSpan);
Â  Â  Â  Â  Â  Â  item.appendChild(select);
Â  Â  Â  Â  Â  Â  vlanPortAssignments.appendChild(item);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  const updateAllVlanVisuals = () => {
Â  Â  Â  Â  Object.values(cables).forEach(cable => {
Â  Â  Â  Â  Â  Â  cable.element.style.stroke = ''; // Reset to default color via CSS
Â  Â  Â  Â  });

Â  Â  Â  Â  Object.values(devices).filter(d => d.type === 'router-v2').forEach(router => {
Â  Â  Â  Â  Â  Â  Object.entries(router.vlanAssignments).forEach(([cableId, vlanId]) => {
Â  Â  Â  Â  Â  Â  Â  Â  const cable = cables[cableId];
Â  Â  Â  Â  Â  Â  Â  Â  if (cable && cable.element) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colorVar = vlanColors[vlanId % vlanColors.length];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cable.element.style.stroke = `var(${colorVar})`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // --- Event Listeners Setup ---
Â  Â  addSelectedDeviceBtn.addEventListener('click', () => {
Â  Â  Â  Â  const selectedType = addDeviceSelect.value;
Â  Â  Â  Â  const typeMap = {
Â  Â  Â  Â  Â  Â  'pc': { name: 'PC', ip: true },
Â  Â  Â  Â  Â  Â  'phone': { name: 'Phone', ip: true },
Â  Â  Â  Â  Â  Â  'router': { name: 'Router', ip: false },
Â  Â  Â  Â  Â  Â  'router-v2': { name: 'RouterV2', ip: false },
Â  Â  Â  Â  Â  Â  'switch': { name: 'Switch', ip: false },
Â  Â  Â  Â  Â  Â  'firewall': { name: 'Firewall', ip: false },
Â  Â  Â  Â  Â  Â  'anti-ddos-system': { name: 'Anti-DDoS', ip: false },
Â  Â  Â  Â  };
Â  Â  Â  Â  if(typeMap[selectedType]) {
Â  Â  Â  Â  Â  Â  addDevice(selectedType, typeMap[selectedType].name, typeMap[selectedType].ip);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  addDdosBtn.addEventListener('click', () => addDevice('ddos', 'DDoS Server', false));
Â  Â  autoIpBtn.addEventListener('click', runDhcp);

Â  Â  addMultiPcBtn.addEventListener('click', () => {
Â  Â  Â  Â  const count = parseInt(multiPcCountInput.value, 10);
Â  Â  Â  Â  if (isNaN(count) || count <= 0) {
Â  Â  Â  Â  Â  Â  addLog("Vui lÃ²ng nháº­p sá»‘ lÆ°á»£ng há»£p lá»‡.", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  addLog(`Äang táº¡o ${count} PC...`, "warn");
Â  Â  Â  Â  for (let i = 0; i < count; i++) addDevice('pc', 'PC');
Â  Â  Â  Â  addLog(`ÄÃ£ táº¡o xong ${count} PC.`, "success");
Â  Â  });
Â  Â Â 
Â  Â  exportBtn.addEventListener('click', exportState);
Â  Â  importBtn.addEventListener('click', () => importFileInput.click());
Â  Â  importFileInput.addEventListener('change', (e) => {
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (event) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const state = JSON.parse(event.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  loadState(state);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  addLog("Lá»—i: KhÃ´ng thá»ƒ Ä‘á»c file JSON.", "error");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  e.target.value = null; // Reset for next import
Â  Â  });
Â  Â Â 
Â  Â  cancelPingBtn.addEventListener('click', endPingProcess);
Â  Â  cancelConnectBtn.addEventListener('click', hideConnectionModal);
Â  Â  infoModalCloseBtn.addEventListener('click', hideDeviceInfoModal);
Â  Â  helpBtn.addEventListener('click', () => { helpModal.style.display = 'flex'; });
Â  Â  helpModalCloseBtn.addEventListener('click', () => { helpModal.style.display = 'none'; });
Â  Â  helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.style.display = 'none'; });
Â  Â Â 
Â  Â  vpnToggle.addEventListener('change', (e) => {
Â  Â  Â  Â  const deviceId = deviceInfoModal.dataset.currentDeviceId;
Â  Â  Â  Â  if (!deviceId || !devices[deviceId]) return;
Â  Â  Â  Â  devices[deviceId].vpnEnabled = e.target.checked;
Â  Â  Â  Â  addLog(`VPN Chá»‘ng DDoS trÃªn ${devices[deviceId].name} Ä‘Ã£ Ä‘Æ°á»£c ${e.target.checked ? "Báº¬T" : "Táº®T"}.`, 'warn');
Â  Â  Â  Â  updateVpnDisplay(deviceId);
Â  Â  Â  Â  updateDeviceIpDisplayInWorkspace(deviceId);
Â  Â  Â  Â  updateAllDeviceStates();Â 
Â  Â  });

Â  Â  connectSelectedBtn.addEventListener('click', () => {
Â  Â  Â  Â  const newDeviceId = connectionModal.dataset.newDeviceId;
Â  Â  Â  Â  if (!newDeviceId) return;
Â  Â  Â  Â  const selectedItems = deviceSelectionList.querySelectorAll('.device-list-item.selected');
Â  Â  Â  Â  addLog(`Äang káº¿t ná»‘i ${devices[newDeviceId].name} vá»›i ${selectedItems.length} thiáº¿t bá»‹...`, 'info');
Â  Â  Â  Â  selectedItems.forEach(item => createCable(newDeviceId, item.dataset.deviceId));
Â  Â  Â  Â  hideConnectionModal();
Â  Â  });

Â  Â  connectAllBtn.addEventListener('click', () => {
Â  Â  Â  Â  const newDeviceId = connectionModal.dataset.newDeviceId;
Â  Â  Â  Â  if (!newDeviceId) return;
Â  Â  Â  Â  const allItems = deviceSelectionList.querySelectorAll('.device-list-item');
Â  Â  Â  Â  addLog(`Äang káº¿t ná»‘i ${devices[newDeviceId].name} vá»›i táº¥t cáº£ ${allItems.length} thiáº¿t bá»‹...`, 'info');
Â  Â  Â  Â  allItems.forEach(item => createCable(newDeviceId, item.dataset.deviceId));
Â  Â  Â  Â  hideConnectionModal();
Â  Â  });

Â  Â  deviceFilterButtons.addEventListener('click', (e) => {
Â  Â  Â  Â  if(e.target.tagName === 'BUTTON') {
Â  Â  Â  Â  Â  Â  deviceFilterButtons.querySelector('button.active')?.classList.remove('active');
Â  Â  Â  Â  Â  Â  e.target.classList.add('active');
Â  Â  Â  Â  Â  Â  populateDeviceList(e.target.dataset.filter);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  addVlanBtn.addEventListener('click', () => {
Â  Â  Â  Â  const routerId = vlanModal.dataset.currentRouterId;
Â  Â  Â  Â  const tempVlans = JSON.parse(vlanModal.dataset.tempVlans);
Â  Â  Â  Â  const vlanId = parseInt(vlanIdInput.value, 10);
Â  Â  Â  Â  const vlanName = vlanNameInput.value.trim();

Â  Â  Â  Â  if (!vlanId || vlanId < 1 || vlanId > 4094) { addLog("VLAN ID pháº£i lÃ  má»™t sá»‘ tá»« 1 Ä‘áº¿n 4094.", "error"); return; }
Â  Â  Â  Â  if (!vlanName) { addLog("Vui lÃ²ng nháº­p tÃªn cho VLAN.", "error"); return; }
Â  Â  Â  Â  if (tempVlans.some(v => v.id === vlanId)) { addLog(`VLAN ID ${vlanId} Ä‘Ã£ tá»“n táº¡i.`, "error"); return; }

Â  Â  Â  Â  tempVlans.push({ id: vlanId, name: vlanName });
Â  Â  Â  Â  vlanModal.dataset.tempVlans = JSON.stringify(tempVlans);
Â  Â  Â  Â  addLog(`ÄÃ£ thÃªm táº¡m thá»i VLAN ${vlanId} (${vlanName}). Nháº¥n LÆ°u Ä‘á»ƒ Ã¡p dá»¥ng.`, "info");
Â  Â  Â  Â  populateVlanPortAssignments(routerId);
Â  Â  Â  Â  vlanIdInput.value = '';
Â  Â  Â  Â  vlanNameInput.value = '';
Â  Â  });
Â  Â Â 
Â  Â  saveVlanConfigBtn.addEventListener('click', () => {
Â  Â  Â  Â  const routerId = vlanModal.dataset.currentRouterId;
Â  Â  Â  Â  const router = devices[routerId];
Â  Â  Â  Â  if (!router) return;

Â  Â  Â  Â  router.vlans = JSON.parse(vlanModal.dataset.tempVlans);
Â  Â  Â  Â  const newAssignments = {};
Â  Â  Â  Â  vlanPortAssignments.querySelectorAll('.vlan-port-item').forEach(item => {
Â  Â  Â  Â  Â  Â  const cableId = item.dataset.cableId;
Â  Â  Â  Â  Â  Â  const select = item.querySelector('select');
Â  Â  Â  Â  Â  Â  const vlanId = select.value ? parseInt(select.value, 10) : null;
Â  Â  Â  Â  Â  Â  if (vlanId) newAssignments[cableId] = vlanId;
Â  Â  Â  Â  });
Â  Â  Â  Â  router.vlanAssignments = newAssignments;
Â  Â  Â  Â  addLog(`ÄÃ£ lÆ°u cáº¥u hÃ¬nh VLAN cho ${router.name}.`, "success");
Â  Â  Â  Â  hideVlanModal();
Â  Â  Â  Â  updateAllDeviceStates();
Â  Â  });

Â  Â  cancelVlanConfigBtn.addEventListener('click', hideVlanModal);
Â  Â Â 
Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  if (!e.target.closest('#cable-context-menu') && !e.target.closest('#cable-svg line')) {
Â  Â  Â  Â  Â  Â  removeCableContextMenu();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  document.addEventListener('keydown', e => {
Â  Â  Â  Â  if (e.key === 'Escape') {
Â  Â  Â  Â  Â  Â  if (helpModal.style.display === 'flex') { helpModal.style.display = 'none'; return; }
Â  Â  Â  Â  Â  Â  if (vlanModal.style.display === 'flex') { hideVlanModal(); return; }
Â  Â  Â  Â  Â  Â  if (pingInProgress) { endPingProcess(); return; }
Â  Â  Â  Â  Â  Â  if (isPingMode) { cancelPingSelection(); return; }
Â  Â  Â  Â  Â  Â  hideConnectionModal();
Â  Â  Â  Â  Â  Â  hideDeviceInfoModal();
Â  Â  Â  Â  Â  Â  removeCableContextMenu();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  new ResizeObserver(updateCablePositions).observe(workspace);
Â  Â  addLog("ChÃ o má»«ng! Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng. Nháº¥n '?' Ä‘á»ƒ xem hÆ°á»›ng dáº«n.", "success");
});
</script>

</body>
</html>
